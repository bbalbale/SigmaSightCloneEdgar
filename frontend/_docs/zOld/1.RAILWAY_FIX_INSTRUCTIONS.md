# Railway Authentication Fix - Instructions for Claude Code

**Priority**: Critical  
**Estimated Time**: 15-30 minutes  
**Impact**: Fixes 401 errors, enables tags API and all Railway features

---

## Problem Summary

The frontend works with local backend but fails with Railway backend because:

1. **apiClient.ts** - Auth interceptor is DISABLED (commented out on lines 326-336)
2. **chatAuthService.ts** - Uses cookies (`credentials: 'include'`) which don't work cross-domain
3. **Inconsistent token access** - Some services use authManager, others use localStorage directly

**Result**: API calls fail with 401 Unauthorized errors on Railway.

---

## Solution Overview

**Strategy**: Use localStorage + Bearer tokens (works cross-domain with Railway)

**What to fix**:
- Enable auth interceptor in apiClient.ts
- Remove cookie dependencies from chatAuthService.ts
- Centralize all token access through authManager

---

## Files to Modify

### File 1: `src/services/apiClient.ts`

**Location**: Lines 326-336

**Current Code** (DISABLED):
```typescript
// Add default request interceptor for auth (when needed)
apiClient.addRequestInterceptor(async (url, config) => {
  // Add auth headers here when authentication is implemented
  // const token = getAuthToken();
  // if (token) {
  //   config.headers = {
  //     ...config.headers,
  //     'Authorization': `Bearer ${token}`,
  //   };
  // }

  return { url, config };
});
```

**New Code** (ENABLED):
```typescript
// Add default request interceptor for auth
apiClient.addRequestInterceptor(async (url, config) => {
  // Get token from localStorage (where authManager stores it)
  const token = typeof window !== 'undefined' ? localStorage.getItem('access_token') : null;
  
  if (token) {
    config.headers = {
      ...config.headers,
      'Authorization': `Bearer ${token}`,
    };
  }

  return { url, config };
});
```

**Why**: This adds Bearer token authentication to all apiClient requests, making them work with Railway.

---

### File 2: `src/services/chatAuthService.ts`

**Changes Needed**:

#### Change 2.1: Line 52 - Remove credentials from login
```typescript
// BEFORE
const response = await fetch(`${this.baseUrl}/api/v1/auth/login`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'include', // REMOVE THIS LINE
  body: JSON.stringify({ email, password }),
});

// AFTER
const response = await fetch(`${this.baseUrl}/api/v1/auth/login`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email, password }),
});
```

#### Change 2.2: Line 149 - Use authManager for token
```typescript
// BEFORE
const response = await fetch(`${this.baseUrl}/api/v1/chat/conversations`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
    'Content-Type': 'application/json',
  },
  credentials: 'include', // REMOVE THIS
  body: JSON.stringify({ ... }),
});

// AFTER
const token = authManager.getAccessToken();
if (!token) {
  console.error('[Auth] No access token available');
  return null;
}

const response = await fetch(`${this.baseUrl}/api/v1/chat/conversations`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({ ... }),
});
```

#### Change 2.3: Line 196 - Remove credentials from logout
```typescript
// BEFORE
await fetch(`${this.baseUrl}/api/v1/auth/logout`, {
  method: 'POST',
  credentials: 'include', // REMOVE THIS
});

// AFTER
const token = authManager.getAccessToken();
await fetch(`${this.baseUrl}/api/v1/auth/logout`, {
  method: 'POST',
  headers: token ? { 'Authorization': `Bearer ${token}` } : {},
});
```

#### Change 2.4: Line 217 - Remove credentials from checkAuth
```typescript
// BEFORE
const response = await fetch(`${this.baseUrl}/api/v1/auth/me`, {
  method: 'GET',
  credentials: 'include', // REMOVE THIS
});

// AFTER
const token = authManager.getAccessToken();
if (!token) {
  this.isAuthenticated = false;
  this.currentUser = null;
  return null;
}

const response = await fetch(`${this.baseUrl}/api/v1/auth/me`, {
  method: 'GET',
  headers: { 'Authorization': `Bearer ${token}` },
});
```

#### Change 2.5: Lines 279-304 - Fix authenticatedFetch method
```typescript
// BEFORE
async authenticatedFetch(url: string, options: RequestInit = {}): Promise<Response> {
  const isValid = await this.refreshIfNeeded();
  if (!isValid) {
    throw new Error('Not authenticated');
  }

  const token = typeof window !== 'undefined' ? localStorage.getItem('access_token') : null;

  return fetch(url, {
    ...options,
    credentials: 'include',
    headers: {
      ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
      ...options.headers,
    },
  });
}

// AFTER
async authenticatedFetch(url: string, options: RequestInit = {}): Promise<Response> {
  const isValid = await this.refreshIfNeeded();
  if (!isValid) {
    throw new Error('Not authenticated');
  }

  const token = authManager.getAccessToken();
  if (!token) {
    throw new Error('No access token available');
  }

  return fetch(url, {
    ...options,
    headers: {
      'Authorization': `Bearer ${token}`,
      ...options.headers,
    },
  });
}
```

---

### File 3 (Optional): `src/services/chatService.ts`

**If this file exists**, update all instances of:

```typescript
// BEFORE
'Authorization': `Bearer ${localStorage.getItem('access_token')}`

// AFTER
import { authManager } from './authManager';
'Authorization': `Bearer ${authManager.getAccessToken()}`
```

**Lines to check**: 158, 184, 209, 238, 281

---

## Implementation Checklist

### Step 1: Update apiClient.ts
- [ ] Locate lines 326-336
- [ ] Uncomment the auth interceptor code
- [ ] Update to use `localStorage.getItem('access_token')`
- [ ] Save file

### Step 2: Update chatAuthService.ts
- [ ] Remove ALL instances of `credentials: 'include'` (8 occurrences)
- [ ] Replace `localStorage.getItem('access_token')` with `authManager.getAccessToken()` (2 occurrences)
- [ ] Add error handling when token is null
- [ ] Save file

### Step 3: (Optional) Update chatService.ts
- [ ] Replace direct localStorage access with authManager calls
- [ ] Save file

---

## Testing Instructions

### Test 1: Verify Token Exists
```javascript
// In browser console after login
console.log('Token exists:', !!localStorage.getItem('access_token'));
```

Expected: `Token exists: true`

### Test 2: Test Tags API
```javascript
// In browser console
import tagsApi from '@/services/tagsApi';
tagsApi.list().then(tags => {
  console.log('SUCCESS! Tags:', tags);
}).catch(err => {
  console.error('FAILED:', err);
});
```

Expected: Returns array of tags, no 401 error

### Test 3: Check Network Headers
1. Open DevTools â†’ Network tab
2. Make any API call
3. Find request to Railway backend
4. Check Headers tab
5. Verify `Authorization: Bearer [token]` is present

Expected: Authorization header is visible with token value

### Test 4: Test Chat Streaming
```javascript
// In browser console
import { chatAuthService } from '@/services/chatAuthService';
chatAuthService.checkAuth().then(user => {
  console.log('Chat auth works:', user);
});
```

Expected: Returns user object, no errors

---

## Validation Criteria

After implementing changes, verify:

- [ ] apiClient auth interceptor is uncommented and active
- [ ] No `credentials: 'include'` in chatAuthService.ts
- [ ] All token access uses authManager
- [ ] Tags API returns data (no 401 errors)
- [ ] Login persists after page refresh
- [ ] Chat features work
- [ ] No console errors related to authentication

---

## Rollback Plan

If something breaks:

```bash
# Revert changes
git checkout src/services/apiClient.ts
git checkout src/services/chatAuthService.ts

# Restart dev server
npm run dev
```

---

## Key Points for Claude Code

1. **Primary fix**: apiClient.ts auth interceptor (lines 326-336) - just uncomment and update
2. **Secondary fix**: chatAuthService.ts - remove all cookie dependencies
3. **Pattern to follow**: authManager.ts already shows the correct approach
4. **No breaking changes**: External APIs stay the same, only internal implementation changes
5. **Test after each file**: Verify tags API works after fixing apiClient, then verify chat after fixing chatAuthService

---

## Expected Outcome

**Before**:
- apiClient requests have no Authorization header
- Railway returns 401 Unauthorized
- Tags API fails
- Chat may fail

**After**:
- All requests include `Authorization: Bearer [token]`
- Railway validates token successfully
- Tags API works
- Chat works
- All features functional with Railway backend

---

## Reference Files

**Don't modify** (these are already correct):
- `src/services/authManager.ts` - Already uses localStorage correctly
- `src/services/requestManager.ts` - Already uses Bearer tokens

**Use these as examples** of the correct pattern.

---

## Additional Notes

- The token is stored in localStorage by authManager during login
- Bearer tokens work cross-domain (unlike cookies)
- All changes are internal - no API changes needed
- Changes are backwards compatible with local backend
- Production deployment will work the same way

---

## Quick Summary for Claude Code

**Task**: Enable Bearer token authentication for Railway backend

**Files to modify**:
1. `src/services/apiClient.ts` - Uncomment auth interceptor (lines 326-336)
2. `src/services/chatAuthService.ts` - Remove cookies, use authManager

**Pattern to follow**: See `src/services/authManager.ts` for reference

**Test**: Tags API should work after changes (no 401 errors)

**Time estimate**: 15-30 minutes
