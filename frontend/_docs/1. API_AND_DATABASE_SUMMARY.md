# SigmaSight API and Database Summary

**Generated**: September 29, 2025
**Last Updated**: December 11, 2025
**Status**: Production-Ready APIs with Complete Database Schema
**Latest Updates**:
- **December 11, 2025**: Comprehensive API audit - updated endpoint count from 63 to 129+, added 9 new categories, updated database schema documentation

--

## Part I: API Endpoints Summary

### Base URL
```
http://localhost:8000/api/v1
```

### Authentication Required
All endpoints except `/auth/login` and `/auth/register` require JWT Bearer token:
```
Authorization: Bearer <jwt_token>
```

---

## ğŸ“ API Endpoints by Category

### ğŸ” Authentication Endpoints (5 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/auth/login` | âœ… Ready | Login with email/password, returns JWT |
| POST | `/auth/register` | âœ… Ready | Register new user |
| GET | `/auth/me` | âœ… Ready | Get current user info |
| POST | `/auth/refresh` | âœ… Ready | Refresh JWT token |
| POST | `/auth/logout` | âœ… Ready | Clear auth cookie |

### ğŸ“Š Data Endpoints (12+ endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/data/portfolios` | âœ… Ready | List user portfolios |
| GET | `/data/portfolio/{id}/complete` | âœ… Ready | Full portfolio snapshot |
| GET | `/data/portfolio/{id}/snapshot` | âœ… Ready | Latest portfolio snapshot with betas |
| GET | `/data/portfolio/{id}/data-quality` | âœ… Ready | Data quality metrics |
| GET | `/data/positions/details` | âœ… Ready | Position details with P&L, investment_class, options data, company names, and notes |
| POST | `/data/positions/restore-sector-tags` | âœ… Ready | Restore sector tags for all positions |
| GET | `/data/positions/top/{id}` | âœ… Ready | Top positions by various metrics |
| GET | `/data/prices/historical/{id}` | âœ… Ready | Historical price data |
| GET | `/data/prices/quotes` | âœ… Ready | Real-time market quotes |
| GET | `/data/factors/etf-prices` | âœ… Ready | Factor ETF prices |
| GET | `/data/company-profiles` | âœ… Ready | Company profiles (53 fields) |
| GET | `/data/test-demo` | âœ… Ready | Test endpoint |
| GET | `/data/demo/{portfolio_type}` | âœ… Ready | Demo data (no auth) |

### ğŸ“ Portfolio CRUD Endpoints (7 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/portfolios` | âœ… Ready | Create new portfolio |
| GET | `/portfolios` | âœ… Ready | List portfolios |
| GET | `/portfolios/{id}` | âœ… Ready | Get single portfolio |
| PUT | `/portfolios/{id}` | âœ… Ready | Update portfolio |
| DELETE | `/portfolios/{id}` | âœ… Ready | Soft delete portfolio |
| POST | `/portfolios/{id}/calculate` | âœ… Ready | Trigger batch calculations |
| GET | `/portfolios/{id}/batch-status/{batch_run_id}` | âœ… Ready | Poll batch status |

### ğŸ“ˆ Analytics Endpoints - Portfolio Level (16+ endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/analytics/portfolio/{id}/overview` | âœ… Ready | Portfolio metrics overview |
| GET | `/analytics/portfolio/{id}/correlation-matrix` | âœ… Ready | Position correlations |
| GET | `/analytics/portfolio/{id}/diversification-score` | âœ… Ready | Portfolio diversification |
| GET | `/analytics/portfolio/{id}/factor-exposures` | âœ… Ready | Portfolio factor betas |
| GET | `/analytics/portfolio/{id}/positions/factor-exposures` | âœ… Ready | Position-level factors |
| GET | `/analytics/portfolio/{id}/stress-test` | âœ… Ready | Stress test scenarios |
| GET | `/analytics/portfolio/{id}/sector-exposure` | âœ… Ready | Sector exposure vs S&P 500 |
| GET | `/analytics/portfolio/{id}/concentration` | âœ… Ready | Concentration metrics (HHI) |
| GET | `/analytics/portfolio/{id}/volatility` | âœ… Ready | Volatility with HAR forecasting |
| GET | `/analytics/portfolio/{id}/beta-comparison` | âœ… Ready | Market beta comparison |
| GET | `/analytics/portfolio/{id}/market-beta` | âœ… Ready | Single factor market beta |
| GET | `/analytics/portfolio/{id}/beta-calculated-90d` | âœ… Ready | 90-day calculated beta |
| GET | `/analytics/portfolio/{id}/beta-provider-1y` | âœ… Ready | 1-year provider beta |
| PUT | `/analytics/portfolio/{id}/equity` | âœ… Ready | Update equity balance |
| POST | `/analytics/portfolio/{id}/calculate` | âœ… Ready | Trigger recalculation |
| GET | `/analytics/portfolio/{id}/batch-status/{batch_run_id}` | âœ… Ready | Poll calculation status |

### ğŸ“Š Analytics Endpoints - Aggregate/Multi-Portfolio (5 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/analytics/overview` | âœ… Ready | Aggregate metrics across all portfolios |
| GET | `/analytics/breakdown` | âœ… Ready | Position breakdown across portfolios |
| GET | `/analytics/beta` | âœ… Ready | Aggregate beta metrics |
| GET | `/analytics/volatility` | âœ… Ready | Aggregate volatility |
| GET | `/analytics/factor-exposures` | âœ… Ready | Aggregate factor exposures |

### ğŸ“Š Analytics Endpoints - Spread Factors (1 endpoint)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/analytics/{portfolio_id}/spread-factors` | âœ… Ready | Spread factor analysis |

### ğŸ’¬ Chat Endpoints (6 endpoints - SSE Streaming)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/chat/conversations` | âœ… Ready | Create conversation |
| GET | `/chat/conversations/{id}` | âœ… Ready | Get conversation |
| GET | `/chat/conversations` | âœ… Ready | List conversations |
| PUT | `/chat/conversations/{id}/mode` | âœ… Ready | Change agent mode |
| DELETE | `/chat/conversations/{id}` | âœ… Ready | Delete conversation |
| POST | `/chat/send` | âœ… Ready | Send message (SSE stream) |

### ğŸ¯ Target Prices Endpoints (10+ endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/target-prices/{portfolio_id}` | âœ… Ready | Create target price |
| GET | `/target-prices/{portfolio_id}` | âœ… Ready | List portfolio targets |
| GET | `/target-prices/{portfolio_id}/summary` | âœ… Ready | Portfolio summary |
| GET | `/target-prices/target/{id}` | âœ… Ready | Get specific target |
| PUT | `/target-prices/target/{id}` | âœ… Ready | Update target price |
| DELETE | `/target-prices/target/{id}` | âœ… Ready | Delete target price |
| POST | `/target-prices/{portfolio_id}/bulk` | âœ… Ready | Bulk create |
| PUT | `/target-prices/{portfolio_id}/bulk-update` | âœ… Ready | Bulk update |
| POST | `/target-prices/{portfolio_id}/import-csv` | âœ… Ready | Import from CSV |
| POST | `/target-prices/{portfolio_id}/export` | âœ… Ready | Export to CSV/JSON |

### ğŸ“ Position Management Endpoints (8+ endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/positions` | âœ… Ready | Create single position |
| POST | `/positions/bulk` | âœ… Ready | Bulk create positions |
| GET | `/positions/{id}` | âœ… Ready | Get single position |
| PUT | `/positions/{id}` | âœ… Ready | Update position |
| DELETE | `/positions/{id}` | âœ… Ready | Delete position |
| DELETE | `/positions/bulk` | âœ… Ready | Bulk delete positions |
| POST | `/positions/validate-symbol` | âœ… Ready | Validate ticker symbol |
| GET | `/positions/check-duplicate` | âœ… Ready | Check for duplicates |
| GET | `/positions/tags-for-symbol` | âœ… Ready | Get tags to inherit |

### ğŸ·ï¸ Position Tagging Endpoints (5 endpoints) - **PREFERRED METHOD**
| Method | Endpoint | Status | Description | Frontend Method |
|--------|----------|--------|-------------|-----------------|
| POST | `/positions/{id}/tags` | âœ… Ready | Add tags to position | `tagsApi.addPositionTags()` |
| DELETE | `/positions/{id}/tags` | âœ… Ready | Remove tags from position | `tagsApi.removePositionTags()` |
| GET | `/positions/{id}/tags` | âœ… Ready | Get position's tags | `tagsApi.getPositionTags()` |
| PATCH | `/positions/{id}/tags` | âœ… Ready | Replace all position tags | `tagsApi.replacePositionTags()` |
| GET | `/tags/{tag_id}/positions` | âœ… Ready | Get positions by tag (reverse lookup) | `tagsApi.getPositionsByTag()` |

### ğŸ·ï¸ Tag Management Endpoints (7 endpoints)
| Method | Endpoint | Status | Description | Frontend Method |
|--------|----------|--------|-------------|-----------------|
| POST | `/tags/` | âœ… Ready | Create new tag | `tagsApi.create()` |
| GET | `/tags/` | âœ… Ready | List user tags | `tagsApi.list()` |
| GET | `/tags/{id}` | âœ… Ready | Get tag details | `tagsApi.get()` |
| PATCH | `/tags/{id}` | âœ… Ready | Update tag | `tagsApi.update()` |
| POST | `/tags/{id}/archive` | âœ… Ready | Archive tag (soft delete) | `tagsApi.delete()` |
| POST | `/tags/{id}/restore` | âœ… Ready | Restore archived tag | `tagsApi.restore()` |
| POST | `/tags/defaults` | âœ… Ready | Create/get default tags (idempotent) | `tagsApi.defaults()` |

### ğŸ’° Equity Changes Endpoints (7 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/portfolios/{portfolio_id}/equity-changes` | âœ… Ready | List equity changes with pagination |
| POST | `/portfolios/{portfolio_id}/equity-changes` | âœ… Ready | Create contribution/withdrawal |
| GET | `/portfolios/{portfolio_id}/equity-changes/summary` | âœ… Ready | Equity change summary |
| GET | `/portfolios/{portfolio_id}/equity-changes/export` | âœ… Ready | Export equity changes |
| GET | `/portfolios/{portfolio_id}/equity-changes/{id}` | âœ… Ready | Get single equity change |
| PUT | `/portfolios/{portfolio_id}/equity-changes/{id}` | âœ… Ready | Update equity change |
| DELETE | `/portfolios/{portfolio_id}/equity-changes/{id}` | âœ… Ready | Delete equity change |

### âš™ï¸ Admin Batch Processing Endpoints (7 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/admin/batch/run` | âœ… Ready | Trigger batch processing with real-time tracking |
| GET | `/admin/batch/run/current` | âœ… Ready | Get current batch status (polling endpoint) |
| POST | `/admin/batch/trigger/market-data` | âœ… Ready | Manually trigger market data update |
| POST | `/admin/batch/trigger/correlations` | âœ… Ready | Manually trigger correlation calculations |
| POST | `/admin/batch/trigger/company-profiles` | âš ï¸ DEPRECATED | Now runs automatically via Railway cron |
| GET | `/admin/batch/data-quality` | âœ… Ready | Get data quality status and metrics |
| POST | `/admin/batch/data-quality/refresh` | âœ… Ready | Refresh market data for quality improvement |

### ğŸ”§ Admin Fix / Data Operations Endpoints (5 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/admin/fix/clear-calculations` | âœ… Ready | Clear all calculation results |
| POST | `/admin/fix/seed-portfolios` | âœ… Ready | Seed demo portfolios |
| POST | `/admin/fix/run-batch` | âœ… Ready | Run batch processing |
| POST | `/admin/fix/fix-all` | âœ… Ready | Complete fix workflow (background) |
| GET | `/admin/fix/jobs/{job_id}` | âœ… Ready | Get fix job status |

### ğŸ“Š Fundamental Data Endpoints (4 endpoints) âœ¨ **NEW - November 2, 2025**
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/fundamentals/{symbol}/income-statement` | âœ… Ready | Get income statements (revenue, margins, EPS) |
| GET | `/fundamentals/{symbol}/balance-sheet` | âœ… Ready | Get balance sheets (assets, liabilities, equity) |
| GET | `/fundamentals/{symbol}/cash-flow` | âœ… Ready | Get cash flows (operating CF, FCF, CapEx) |
| GET | `/fundamentals/{symbol}/analyst-estimates` | âœ… Ready | Get analyst estimates (4 periods: 0q, +1q, 0y, +1y) |

**Data Source**: Financial statements stored in database (populated by batch orchestrator Phase 1.5)

**Implementation**:
- **Backend**: `app/api/v1/fundamentals.py` (270 lines, 4 endpoints)
- **Database**: `income_statements`, `balance_sheets`, `cash_flows` tables
- **Schemas**: `app/schemas/fundamentals.py` (simplified response models with direct DB mapping)
- **Router**: Registered in `app/api/v1/router.py` with `/fundamentals` prefix

#### 1. Income Statement Endpoint
**Path**: `GET /api/v1/fundamentals/{symbol}/income-statement`

**Query Parameters**:
- `periods` (default: 4, range: 1-20) - Number of periods to return
- `frequency` (default: "q", options: "q" or "a") - Quarterly or annual

**Response Fields** (22 financial fields per period):
- **Period Info**: period_date, frequency, fiscal_year, fiscal_quarter
- **Revenue & Costs**: total_revenue, cost_of_revenue, gross_profit, gross_margin
- **Operating**: operating_income, operating_margin, ebit, ebitda
- **Net Income**: net_income, net_margin, diluted_eps, basic_eps
- **Share Counts**: basic_average_shares, diluted_average_shares (BIGINT for large cap stocks)
- **Tax & Interest**: tax_provision, interest_expense, depreciation_and_amortization

#### 2. Balance Sheet Endpoint
**Path**: `GET /api/v1/fundamentals/{symbol}/balance-sheet`

**Response Fields** (29 financial fields per period):
- **Assets**: total_assets, current_assets, cash_and_cash_equivalents, accounts_receivable, inventory
- **Liabilities**: total_liabilities, current_liabilities, accounts_payable, short_term_debt, long_term_debt, total_debt
- **Equity**: total_stockholders_equity, retained_earnings, common_stock
- **Calculated Metrics**: working_capital, net_debt, current_ratio, debt_to_equity

#### 3. Cash Flow Endpoint
**Path**: `GET /api/v1/fundamentals/{symbol}/cash-flow`

**Response Fields** (19 financial fields per period):
- **Operating Activities**: operating_cash_flow, stock_based_compensation
- **Investing Activities**: investing_cash_flow, capital_expenditures
- **Financing Activities**: financing_cash_flow, dividends_paid, stock_repurchases
- **Calculated Metrics**: free_cash_flow (operating CF - CapEx), fcf_margin

#### 4. Analyst Estimates Endpoint
**Path**: `GET /api/v1/fundamentals/{symbol}/analyst-estimates`

Returns all 4 periods: 0q (current quarter), +1q (next quarter), 0y (current year), +1y (next year)

**Response Fields** (24 estimate fields):
- Current Quarter (0q): eps_avg/low/high, revenue_avg/low/high, analyst_count, target_period_date
- Next Quarter (+1q): eps_avg/low/high, revenue_avg/low/high, analyst_count, target_period_date
- Current Year (0y): earnings_avg/low/high, revenue_avg/low/high, analyst_count, end_date
- Next Year (+1y): earnings_avg/low/high, revenue_avg/low/high, analyst_count, end_date

### ğŸ’¡ Insights / AI-Powered Analysis Endpoints (5 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/insights/generate` | âœ… Ready | Generate AI insights for portfolio |
| GET | `/insights/portfolio/{portfolio_id}` | âœ… Ready | List portfolio insights |
| GET | `/insights/{insight_id}` | âœ… Ready | Get single insight |
| PATCH | `/insights/{insight_id}` | âœ… Ready | Update insight metadata |
| POST | `/insights/{insight_id}/feedback` | âœ… Ready | Submit feedback/rating on insight |

### ğŸ‘‹ Onboarding Endpoints (3 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/onboarding/register` | âœ… Ready | Register new user with invite code |
| POST | `/onboarding/create-portfolio` | âœ… Ready | Create portfolio with CSV import |
| GET | `/onboarding/csv-template` | âœ… Ready | Download CSV template |

### ğŸ¢ Company Profiles Endpoint (1 endpoint)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/data/company-profiles` | âœ… Ready | Get company profiles with 53+ fields (flexible query modes) |

**Query Modes** (exactly one required):
- **symbols**: Direct symbol lookup (e.g., `?symbols=AAPL,MSFT,GOOGL`) - public data, no ownership check
- **position_ids**: Fetch profiles for specific positions (requires ownership)
- **portfolio_id**: Fetch profiles for all portfolio symbols (requires ownership)

**Company Profile Fields** (53 total):
- **Basic Info**: company_name, sector, industry, exchange, country, market_cap, description
- **Company Type**: is_etf, is_fund
- **Company Details**: ceo, employees, website
- **Valuation Metrics**: pe_ratio, forward_pe, dividend_yield, beta, week_52_high, week_52_low
- **Analyst Data**: target_mean_price, target_high_price, target_low_price, number_of_analyst_opinions, recommendation_mean, recommendation_key
- **Forward Estimates**: forward_eps, earnings_growth, revenue_growth, earnings_quarterly_growth
- **Profitability**: profit_margins, operating_margins, gross_margins, return_on_assets, return_on_equity, total_revenue
- **Current Year Estimates**: current_year_revenue_avg/_low/_high, current_year_revenue_growth, current_year_earnings_avg/_low/_high, current_year_end_date
- **Next Year Estimates**: next_year_revenue_avg/_low/_high, next_year_revenue_growth, next_year_earnings_avg/_low/_high, next_year_end_date
- **Quarterly Estimates (0q, +1q)**: target_period_date, revenue/eps avg/low/high, analyst_count
- **Fiscal Calendar**: fiscal_year_end, fiscal_quarter_offset
- **Next Earnings**: next_earnings_date, next_earnings_expected_eps, next_earnings_expected_revenue
- **Data Tracking**: fundamentals_last_fetched, data_source (default: 'yahooquery'), last_updated, created_at, updated_at

---

### ğŸ“‹ Summary Statistics
- **Total Endpoints**: 129+ endpoints across 17 categories
- **Production Ready**: 129+ (100%)
- **Removed (Strategies)**: 12 endpoints removed October 2025

**Endpoint Breakdown**:
- Authentication: 5 endpoints
- Data: 12+ endpoints
- Portfolio CRUD: 7 endpoints
- Analytics (Portfolio): 16+ endpoints
- Analytics (Aggregate): 5 endpoints
- Analytics (Spread Factors): 1 endpoint
- Chat: 6 endpoints (SSE streaming)
- Target Prices: 10+ endpoints
- Position Management: 8+ endpoints
- Position Tagging: 5 endpoints
- Tag Management: 7 endpoints
- Equity Changes: 7 endpoints
- Admin Batch Processing: 7 endpoints
- Admin Fix: 5 endpoints
- Fundamental Data: 4 endpoints
- Insights: 5 endpoints
- Onboarding: 3 endpoints
- Company Profiles: 1 endpoint

---

## Part I-B: Frontend Integration Status

### ğŸ¨ Frontend Services Implementation

| Service | File | Methods | Status | Notes |
|---------|------|---------|--------|-------|
| **Position Tagging** | `src/services/tagsApi.ts` | 5/5 | âœ… 100% | Direct position tagging (preferred) |
| **Tags** | `src/services/tagsApi.ts` | 10/10 | âœ… 100% | Full tag lifecycle + bulk operations |
| **Strategies** | `src/services/strategiesApi.ts` | 0/0 | ğŸ—‘ï¸ Removed | Delete service + migrate to tag flows |
| **Analytics** | `src/services/analyticsApi.ts` | 6/6 | âœ… 100% | Portfolio analytics endpoints |
| **Fundamentals** | `src/services/fundamentalsApi.ts` | 4/4 | âœ… 100% | Financial statements + analyst estimates |
| **Portfolio** | `src/services/portfolioService.ts` | 1/1 | âœ… 100% | Load portfolio data (composite) |
| **Auth** | `src/services/authManager.ts` | - | âœ… 100% | JWT token management |

### ğŸ§© Frontend Components Implementation

| Component | File | Purpose | Status | Notes |
|-----------|------|---------|--------|-------|
| **usePositionTags** | `src/hooks/usePositionTags.ts` | React hook | âœ… Complete | Position tag state management |
| **useTags** | `src/hooks/useTags.ts` | React hook | âœ… Complete | Tag CRUD operations |
| **TagBadge** | `src/components/organize/TagBadge.tsx` | Tag display | âœ… Complete | Drag-drop support, color customization |

---

## Part II: Database Schema

### ğŸ—„ï¸ Database Overview
- **Type**: PostgreSQL (via Docker)
- **ORM**: SQLAlchemy 2.0 with async support
- **Migrations**: Alembic
- **Primary Keys**: UUID for all tables

### ğŸ“Š Complete Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SIGMASIGHT DATABASE SCHEMA                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CORE USER & PORTFOLIO MODELS                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     USERS       â”‚       â”‚   PORTFOLIOS    â”‚       â”‚   POSITIONS     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)    PK â”‚â”€â”€â”€â”   â”‚ id (UUID)    PK â”‚â”€â”€â”€â”   â”‚ id (UUID)    PK â”‚
â”‚ email           â”‚   â”‚   â”‚ user_id      FK â”‚   â”‚   â”‚ portfolio_id FK â”‚
â”‚ hashed_password â”‚   â””â”€â”€<â”‚ name            â”‚   â””â”€â”€<â”‚ symbol          â”‚
â”‚ full_name       â”‚       â”‚ account_name    â”‚       â”‚ position_type   â”‚
â”‚ is_active       â”‚       â”‚ account_type    â”‚       â”‚ quantity        â”‚
â”‚ created_at      â”‚       â”‚ currency        â”‚       â”‚ entry_price     â”‚
â”‚ updated_at      â”‚       â”‚ equity_balance  â”‚       â”‚ entry_date      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ description     â”‚       â”‚ exit_price      â”‚
                          â”‚ is_active       â”‚       â”‚ exit_date       â”‚
                          â”‚ deleted_at      â”‚       â”‚ investment_classâ”‚
                          â”‚ created_at      â”‚       â”‚ last_price      â”‚
                          â”‚ updated_at      â”‚       â”‚ market_value    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ unrealized_pnl  â”‚
                                                    â”‚ realized_pnl    â”‚
                                                    â”‚ notes           â”‚
                                                    â”‚ deleted_at      â”‚
                                                    â”‚ created_at      â”‚
                                                    â”‚ updated_at      â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TAGGING SYSTEM TABLES                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       TAGS_V2              â”‚         â”‚     POSITION_TAGS          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)               PK â”‚         â”‚ id (UUID)               PK â”‚
â”‚ user_id                 FK â”‚â”€â”€â”€â”     â”‚ position_id             FK â”‚
â”‚ name                       â”‚   â”‚     â”‚ tag_id                  FK â”‚
â”‚ color                      â”‚   â”‚     â”‚ assigned_at                â”‚
â”‚ description                â”‚   â”‚     â”‚ assigned_by             FK â”‚
â”‚ display_order              â”‚   â””â”€â”€â”€â”€<â”‚ UNIQUE(position_id, tag_id)â”‚
â”‚ usage_count                â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ is_archived                â”‚
â”‚ archived_at                â”‚
â”‚ archived_by             FK â”‚
â”‚ created_at                 â”‚
â”‚ updated_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MARKET DATA & ANALYTICS                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MARKET_DATA_CACHE   â”‚  â”‚   COMPANY_PROFILES   â”‚  â”‚  POSITION_GREEKS     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ symbol (PK)          â”‚  â”‚ id (UUID)         PK â”‚
â”‚ symbol               â”‚  â”‚ company_name         â”‚  â”‚ position_id       FK â”‚
â”‚ date                 â”‚  â”‚ sector, industry     â”‚  â”‚ calculation_date     â”‚
â”‚ open, high, low      â”‚  â”‚ exchange, country    â”‚  â”‚ delta, gamma         â”‚
â”‚ close, volume        â”‚  â”‚ market_cap           â”‚  â”‚ theta, vega, rho     â”‚
â”‚ sector, industry     â”‚  â”‚ pe_ratio, beta       â”‚  â”‚ delta_dollars        â”‚
â”‚ market_cap           â”‚  â”‚ 53 fields total...   â”‚  â”‚ gamma_dollars        â”‚
â”‚ data_source          â”‚  â”‚ last_updated         â”‚  â”‚ created_at           â”‚
â”‚ created_at           â”‚  â”‚ created_at           â”‚  â”‚ updated_at           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POSITION_VOLATILITY  â”‚  â”‚  FACTOR_EXPOSURES    â”‚  â”‚ POSITION_FACTOR_EXP  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ position_id       FK â”‚  â”‚ portfolio_id      FK â”‚  â”‚ position_id       FK â”‚
â”‚ calculation_date     â”‚  â”‚ factor_id         FK â”‚  â”‚ factor_id         FK â”‚
â”‚ realized_vol_21d     â”‚  â”‚ calculation_date     â”‚  â”‚ calculation_date     â”‚
â”‚ realized_vol_63d     â”‚  â”‚ exposure_value       â”‚  â”‚ exposure_value       â”‚
â”‚ expected_vol_21d     â”‚  â”‚ exposure_dollar      â”‚  â”‚ quality_flag         â”‚
â”‚ vol_trend            â”‚  â”‚ created_at           â”‚  â”‚ created_at           â”‚
â”‚ vol_percentile       â”‚  â”‚ updated_at           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ created_at           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POSITION_MARKET_BETASâ”‚  â”‚POSITION_IR_BETAS     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ portfolio_id      FK â”‚  â”‚ portfolio_id      FK â”‚
â”‚ position_id       FK â”‚  â”‚ position_id       FK â”‚
â”‚ calc_date            â”‚  â”‚ ir_beta              â”‚
â”‚ beta, alpha          â”‚  â”‚ r_squared            â”‚
â”‚ r_squared, std_error â”‚  â”‚ calculation_date     â”‚
â”‚ p_value, observationsâ”‚  â”‚ created_at           â”‚
â”‚ window_days, method  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ market_index         â”‚
â”‚ created_at           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SNAPSHOT & HISTORY TABLES                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PORTFOLIO_SNAPSHOTS (Daily)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID) PK                                                                 â”‚
â”‚ portfolio_id FK                                                              â”‚
â”‚ snapshot_date                                                                â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ Valuations â”€â”€                                                             â”‚
â”‚ net_asset_value (total_value), cash_value, long_value, short_value          â”‚
â”‚ gross_exposure, net_exposure                                                 â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ P&L Tracking â”€â”€                                                           â”‚
â”‚ daily_pnl, daily_return, cumulative_pnl                                     â”‚
â”‚ daily_realized_pnl, cumulative_realized_pnl                                 â”‚
â”‚ daily_capital_flow, cumulative_capital_flow                                 â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ Greeks â”€â”€                                                                 â”‚
â”‚ portfolio_delta, portfolio_gamma, portfolio_theta, portfolio_vega           â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ Position Counts â”€â”€                                                        â”‚
â”‚ num_positions, num_long_positions, num_short_positions                      â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ Equity â”€â”€                                                                 â”‚
â”‚ equity_balance                                                               â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ Volatility Analytics (Phase 2) â”€â”€                                         â”‚
â”‚ realized_volatility_21d, realized_volatility_63d, expected_volatility_21d   â”‚
â”‚ volatility_trend, volatility_percentile                                     â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ Market Beta (Phase 0) â”€â”€                                                  â”‚
â”‚ beta_calculated_90d, beta_calculated_90d_r_squared                          â”‚
â”‚ beta_calculated_90d_observations, beta_provider_1y                          â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ Sector Exposure (Phase 1) â”€â”€                                              â”‚
â”‚ sector_exposure (JSON), hhi, effective_num_positions                        â”‚
â”‚ top_3_concentration, top_10_concentration                                   â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€ Target Prices â”€â”€                                                          â”‚
â”‚ target_return_pct, target_dollar_values, coverage_metrics                   â”‚
â”‚                                                                              â”‚
â”‚ is_complete, created_at                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CORRELATION TABLES                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CORRELATION_CALCS    â”‚  â”‚ CORRELATION_CLUSTERS â”‚  â”‚ PAIRWISE_CORRELATIONSâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ portfolio_id      FK â”‚  â”‚ correlation_calc  FK â”‚  â”‚ correlation_calc  FK â”‚
â”‚ duration_days        â”‚  â”‚ cluster_number       â”‚  â”‚ symbol_1, symbol_2   â”‚
â”‚ calculation_date     â”‚  â”‚ nickname             â”‚  â”‚ correlation_value    â”‚
â”‚ overall_correlation  â”‚  â”‚ avg_correlation      â”‚  â”‚ data_points          â”‚
â”‚ effective_positions  â”‚  â”‚ total_value          â”‚  â”‚ stat_significance    â”‚
â”‚ data_quality         â”‚  â”‚ portfolio_percentage â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ positions_included   â”‚  â”‚ created_at           â”‚
â”‚ created_at           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STRESS TEST & RISK TABLES                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STRESS_SCENARIOS    â”‚  â”‚  STRESS_TEST_RESULTS â”‚  â”‚ MARKET_RISK_SCENARIOSâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ scenario_id          â”‚  â”‚ portfolio_id      FK â”‚  â”‚ portfolio_id      FK â”‚
â”‚ name                 â”‚  â”‚ scenario_id       FK â”‚  â”‚ scenario_type        â”‚
â”‚ description          â”‚  â”‚ calculation_date     â”‚  â”‚ scenario_value       â”‚
â”‚ category             â”‚  â”‚ direct_pnl           â”‚  â”‚ predicted_pnl        â”‚
â”‚ severity             â”‚  â”‚ correlated_pnl       â”‚  â”‚ calculation_date     â”‚
â”‚ shock_config (JSONB) â”‚  â”‚ correlation_effect   â”‚  â”‚ created_at           â”‚
â”‚ active               â”‚  â”‚ factor_impacts (JSON)â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ created_at           â”‚  â”‚ created_at           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TARGET PRICE & P&L TABLES                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PORTFOLIO_TARGET_PRICES   â”‚         â”‚  POSITION_REALIZED_EVENTS  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)               PK â”‚         â”‚ id (UUID)               PK â”‚
â”‚ portfolio_id            FK â”‚         â”‚ position_id             FK â”‚
â”‚ position_id             FK â”‚         â”‚ portfolio_id            FK â”‚
â”‚ symbol                     â”‚         â”‚ trade_date                 â”‚
â”‚ position_type              â”‚         â”‚ quantity_closed            â”‚
â”‚ target_price_eoy           â”‚         â”‚ realized_pnl               â”‚
â”‚ target_price_next_year     â”‚         â”‚ created_at                 â”‚
â”‚ downside_target_price      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ current_price              â”‚
â”‚ expected_return_eoy        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ expected_return_next_year  â”‚         â”‚    EQUITY_CHANGES          â”‚
â”‚ downside_return            â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ position_weight            â”‚         â”‚ id (UUID)               PK â”‚
â”‚ contribution_to_portfolio  â”‚         â”‚ portfolio_id            FK â”‚
â”‚ contribution_to_risk       â”‚         â”‚ change_type (ENUM)         â”‚
â”‚ price_updated_at           â”‚         â”‚ amount                     â”‚
â”‚ created_at                 â”‚         â”‚ change_date                â”‚
â”‚ updated_at                 â”‚         â”‚ notes                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ created_by_user_id      FK â”‚
                                       â”‚ deleted_at                 â”‚
                                       â”‚ created_at                 â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FUNDAMENTAL DATA TABLES                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INCOME_STATEMENTS   â”‚  â”‚   BALANCE_SHEETS     â”‚  â”‚    CASH_FLOWS        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ symbol               â”‚  â”‚ symbol               â”‚  â”‚ symbol               â”‚
â”‚ period_date          â”‚  â”‚ period_date          â”‚  â”‚ period_date          â”‚
â”‚ fiscal_year/quarter  â”‚  â”‚ fiscal_year/quarter  â”‚  â”‚ fiscal_year/quarter  â”‚
â”‚ frequency            â”‚  â”‚ frequency            â”‚  â”‚ frequency            â”‚
â”‚ total_revenue        â”‚  â”‚ total_assets         â”‚  â”‚ operating_cash_flow  â”‚
â”‚ gross_profit         â”‚  â”‚ current_assets       â”‚  â”‚ investing_cash_flow  â”‚
â”‚ operating_income     â”‚  â”‚ total_liabilities    â”‚  â”‚ financing_cash_flow  â”‚
â”‚ net_income           â”‚  â”‚ stockholders_equity  â”‚  â”‚ free_cash_flow       â”‚
â”‚ diluted_eps          â”‚  â”‚ working_capital      â”‚  â”‚ capital_expenditures â”‚
â”‚ ... (22 fields)      â”‚  â”‚ ... (29 fields)      â”‚  â”‚ ... (19 fields)      â”‚
â”‚ created_at           â”‚  â”‚ created_at           â”‚  â”‚ created_at           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AI & INSIGHTS TABLES                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AI_INSIGHTS                â”‚  â”‚      AI_INSIGHT_TEMPLATES        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID) PK                         â”‚  â”‚ id (UUID) PK                     â”‚
â”‚ portfolio_id FK                      â”‚  â”‚ insight_type (Enum)              â”‚
â”‚ insight_type, severity               â”‚  â”‚ name, version                    â”‚
â”‚ title, summary, full_analysis        â”‚  â”‚ description                      â”‚
â”‚ key_findings (JSON)                  â”‚  â”‚ system_prompt (Jinja2)           â”‚
â”‚ recommendations (JSON)               â”‚  â”‚ investigation_prompt             â”‚
â”‚ context_data (JSON)                  â”‚  â”‚ model_preference, max_tokens     â”‚
â”‚ model_used, provider                 â”‚  â”‚ required_tools (JSON)            â”‚
â”‚ cost_usd, generation_time_ms         â”‚  â”‚ active, avg_quality_score        â”‚
â”‚ token_count_input/output             â”‚  â”‚ usage_count                      â”‚
â”‚ cache_hit, cache_key                 â”‚  â”‚ created_at, deprecated_at        â”‚
â”‚ user_rating, user_feedback           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ viewed, dismissed                    â”‚
â”‚ created_at, expires_at               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CHAT/AGENT TABLES                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   agent.CONVERSATIONS      â”‚         â”‚    agent.MESSAGES          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)               PK â”‚         â”‚ id (UUID)               PK â”‚
â”‚ user_id                 FK â”‚â”€â”€â”€â”     â”‚ conversation_id         FK â”‚
â”‚ portfolio_id            FK â”‚   â”‚     â”‚ role                       â”‚
â”‚ mode                       â”‚   â””â”€â”€â”€â”€<â”‚ content                    â”‚
â”‚ provider                   â”‚         â”‚ tool_calls                 â”‚
â”‚ provider_thread_id         â”‚         â”‚ created_at                 â”‚
â”‚ created_at                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          BATCH PROCESSING TABLES                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    BATCH_JOBS        â”‚  â”‚ BATCH_JOB_SCHEDULES  â”‚  â”‚ BATCH_RUN_TRACKING   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ job_name             â”‚  â”‚ job_name             â”‚  â”‚ run_date (unique)    â”‚
â”‚ job_type             â”‚  â”‚ job_type             â”‚  â”‚ phase_1/2/3_status   â”‚
â”‚ status               â”‚  â”‚ cron_expression      â”‚  â”‚ phase_1/2/3_duration â”‚
â”‚ portfolio_id      FK â”‚  â”‚ is_active            â”‚  â”‚ portfolios_processed â”‚
â”‚ started_at           â”‚  â”‚ description          â”‚  â”‚ symbols_fetched      â”‚
â”‚ completed_at         â”‚  â”‚ timeout_seconds      â”‚  â”‚ data_coverage_pct    â”‚
â”‚ error_message        â”‚  â”‚ retry_count/delay    â”‚  â”‚ error_message        â”‚
â”‚ job_metadata (JSON)  â”‚  â”‚ last_run_at          â”‚  â”‚ completed_at         â”‚
â”‚ created_at           â”‚  â”‚ next_run_at          â”‚  â”‚ created_at           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          OTHER SUPPORTING TABLES                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FACTOR_DEFINITIONS   â”‚  â”‚ FACTOR_CORRELATIONS  â”‚  â”‚ FUND_HOLDINGS        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ name (unique)        â”‚  â”‚ factor_1_id       FK â”‚  â”‚ fund_symbol          â”‚
â”‚ description          â”‚  â”‚ factor_2_id       FK â”‚  â”‚ holding_symbol       â”‚
â”‚ factor_type          â”‚  â”‚ correlation          â”‚  â”‚ holding_name         â”‚
â”‚ etf_proxy            â”‚  â”‚ calculation_date     â”‚  â”‚ weight, shares       â”‚
â”‚ display_order        â”‚  â”‚ lookback_days        â”‚  â”‚ market_value         â”‚
â”‚ is_active            â”‚  â”‚ decay_factor         â”‚  â”‚ data_source          â”‚
â”‚ created_at           â”‚  â”‚ data_points          â”‚  â”‚ last_updated         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚BENCHMARKS_SECTOR_WGTSâ”‚  â”‚ MODELING_SNAPSHOTS   â”‚  â”‚   EXPORT_HISTORY     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ benchmark_code       â”‚  â”‚ session_id (unique)  â”‚  â”‚ user_id           FK â”‚
â”‚ asof_date            â”‚  â”‚ user_id           FK â”‚  â”‚ export_type          â”‚
â”‚ sector               â”‚  â”‚ name                 â”‚  â”‚ export_format        â”‚
â”‚ weight               â”‚  â”‚ status               â”‚  â”‚ file_name            â”‚
â”‚ market_cap           â”‚  â”‚ base_portfolio_snap  â”‚  â”‚ file_size_bytes      â”‚
â”‚ num_constituents     â”‚  â”‚ modified_snap (JSON) â”‚  â”‚ created_at           â”‚
â”‚ data_source          â”‚  â”‚ changes (JSON)       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ created_at           â”‚  â”‚ impact_summary       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ created_at           â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”‘ Key Relationships

#### Primary Relationships:
1. **Users â†’ Portfolios**: One-to-Many (1 user has multiple portfolios)
2. **Portfolios â†’ Positions**: One-to-Many (1 portfolio has multiple positions)
3. **Users â†’ Tags**: One-to-Many (user-scoped tagging system)
4. **Tags â†” Positions**: Many-to-Many via `position_tags`
5. **Portfolios â†’ Portfolio Snapshots**: One-to-Many (historical snapshots)
6. **Positions â†’ Greeks/Factors/Betas**: One-to-Many (calculation results)
7. **Portfolios â†’ Target Prices**: One-to-Many (price targets per position)
8. **Users â†’ Conversations**: One-to-Many (chat threads)
9. **Conversations â†’ Messages**: One-to-Many (chat history)
10. **Positions â†’ Company Profiles**: Many-to-One via symbol (company metadata lookup)
11. **Portfolios â†’ AI Insights**: One-to-Many (generated insights)
12. **Portfolios â†’ Equity Changes**: One-to-Many (contributions/withdrawals)

#### Investment Classification:
- **Position.investment_class**: Database field (PUBLIC/OPTIONS/PRIVATE)
  - PUBLIC: Regular equities, ETFs
  - OPTIONS: Options contracts (LC, LP, SC, SP position types)
  - PRIVATE: Private/alternative investments
- **Position.investment_subtype**: Optional categorization within investment class

#### Position Types:
- LONG: Long equity position
- SHORT: Short equity position
- LC: Long Call option
- LP: Long Put option
- SC: Short Call option (covered/naked)
- SP: Short Put option

---

## Part III: Frontend Services Architecture

### Service Layer Overview
The frontend uses a layered service architecture to interact with the backend API. All API calls should go through the service layer rather than being made directly from components.

### Frontend Services and API Endpoints

| Service | Purpose | API Endpoints Used | Used By |
|---------|---------|-------------------|----------|
| **apiClient.ts** | Base HTTP client with proxy support | All endpoints (infrastructure) | All services |
| **authManager.ts** | JWT token management & authentication | `/auth/login`, `/auth/me` | portfolioService, components |
| **portfolioService.ts** | Main portfolio data fetching | `/analytics/portfolio/{id}/overview`<br>`/data/positions/details`<br>`/analytics/portfolio/{id}/factor-exposures` | usePortfolioData hook |
| **portfolioResolver.ts** | Dynamic portfolio ID resolution | `/data/portfolios`<br>`/data/portfolio/{id}/complete` | portfolioService |
| **analyticsApi.ts** | Analytics & calculations | `/analytics/portfolio/{id}/overview`<br>`/analytics/portfolio/{id}/correlation-matrix`<br>`/analytics/portfolio/{id}/factor-exposures`<br>`/analytics/portfolio/{id}/stress-test`<br>`/analytics/portfolio/{id}/volatility` | Dashboard, Analytics pages |
| **fundamentalsApi.ts** | Fundamental data (financial statements) | `/fundamentals/{symbol}/income-statement`<br>`/fundamentals/{symbol}/balance-sheet`<br>`/fundamentals/{symbol}/cash-flow`<br>`/fundamentals/{symbol}/analyst-estimates` | Position detail views, Research |
| **portfolioApi.ts** | Portfolio CRUD operations | `/portfolios`<br>`/data/portfolio/{id}/complete`<br>`/data/portfolio/{id}/data-quality` | Portfolio management |
| **positionApiService.ts** | Position details & operations | `/positions`<br>`/data/positions/details` | Position components |
| **companyProfilesApi.ts** | Company profile data | `/data/company-profiles` | Position cards, research views |
| **tagsApi.ts** | Tag + position tagging | `/tags/`<br>`/tags/defaults`<br>`/positions/{id}/tags`<br>`/tags/{id}/positions` | TagEditor, Organize page |
| **chatService.ts** | Chat conversation management | `/chat/conversations`<br>`/chat/send`<br>`/chat/conversations/{id}/mode` | ChatInterface component |
| **chatAuthService.ts** | Chat auth & streaming | `/auth/login`<br>`/auth/logout`<br>`/auth/me`<br>`/chat/send` | Chat components |
| **requestManager.ts** | Request retry & deduplication | N/A (infrastructure) | All services |

### Service Architecture Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Components/Pages                         â”‚
â”‚      (PortfolioPage, ChatInterface, TagEditor, etc.)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Custom Hooks                           â”‚
â”‚           (usePortfolioData, useFetchStreaming, etc.)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Service Layer                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Feature APIs â”‚ â”‚   Auth       â”‚ â”‚    Infrastructure        â”‚ â”‚
â”‚ â”‚analyticsApi â”‚ â”‚authManager   â”‚ â”‚    apiClient             â”‚ â”‚
â”‚ â”‚portfolioApi â”‚ â”‚chatAuthServiceâ”‚ â”‚    requestManager        â”‚ â”‚
â”‚ â”‚tagsApi      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚fundamentalsApiâ”‚                                              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js API Proxy                           â”‚
â”‚                    (/api/proxy/[...path])                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend API (FastAPI)                        â”‚
â”‚                    http://localhost:8000                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Best Practices

1. **Always use services** - Don't make direct fetch() calls to backend
2. **Use appropriate service** - Each service has a specific domain responsibility
3. **Handle errors gracefully** - Services provide consistent error handling
4. **Leverage request manager** - Automatic retry and deduplication
5. **Type safety** - Services provide TypeScript interfaces for responses

---

## Recent Updates & Fixes

### December 11, 2025: Comprehensive API Audit
- Updated endpoint count from 63 to 129+ across 17 categories
- Added new categories: Portfolio CRUD, Position Management, Equity Changes, Fundamental Data, Insights, Onboarding, Admin Fix
- Updated database schema documentation with all current tables
- Added Analytics Aggregate and Spread Factors endpoints

### Phase 10.1-10.2: Railway Cron Hardening (October 7, 2025)
- Removed 4x market data duplication
- Market data now synced once per portfolio
- Critical vs non-critical job distinction
- Enhanced failure detection with job-level failure details

### Phase 9.1-9.2: Company Profile Integration (October 7, 2025)
- Automated company profile sync via Railway cron (11:30 PM UTC daily)
- Non-blocking failures for graceful degradation
- Updated workflow: 5-step process

### Phase 9.0: Company Profile Fetcher Rewrite (October 7, 2025)
- Complete async rewrite via `run_in_executor()`
- Batching + parallelism (batch of 10, max_workers=3)
- Exponential backoff retry
- 53 comprehensive fields from yfinance + yahooquery

---

## Backend Services Architecture

### Company Profile Fetcher Service
**File**: `app/services/yahooquery_profile_fetcher.py`

**Purpose**: Fetch comprehensive company profile data from external APIs

**Data Sources**:
- **yfinance**: Basic company info (reliable, no rate limits)
- **yahooquery**: Revenue/earnings estimates (unique data)

**Key Features**:
- Async-safe execution via `run_in_executor()`
- Batching (10 symbols per batch)
- Parallelism (ThreadPoolExecutor, max_workers=3)
- Exponential backoff retry
- 53 comprehensive fields

**Performance**:
- Batch of 10 symbols: ~3-5 seconds
- Portfolio of 50 symbols: ~15-20 seconds
- Automatic sync via Railway cron at 11:30 PM UTC

---

## Notes

- **Database Location**: PostgreSQL via Docker (`docker-compose up -d`)
- **Migrations**: Managed via Alembic (`uv run alembic upgrade head`)
- **Demo Data**: Pre-seeded with `scripts/database/reset_and_seed.py`
- **Admin Endpoints**: Fully implemented (7 batch + 5 fix endpoints)
- **Company Profiles**: 53 comprehensive fields, automatic daily sync via Railway cron
- **Fundamental Data**: 4 endpoints with database-backed financial statements
- **Testing**: Frontend API test page at `/dev/api-test` validates all endpoints
- **AI Integration**: OpenAI Responses API (NOT Chat Completions API) for all chat functionality


## ğŸ—ï¸ Tagging System Architecture Clarification

> **IMPORTANT**: The tagging system uses a **3-file architecture** that may appear to be "different services by different developers" - **this is intentional design**, not technical debt!

### Architecture Overview

```
ğŸ“‚ Backend Files (3-Tier Separation of Concerns)
â”œâ”€â”€ position_tags.py    â†’ Position-Tag Relationship Operations
â”œâ”€â”€ tags.py             â†’ Tag Management + Reverse Lookups
â””â”€â”€ tags_v2.py          â†’ Database Models

ğŸ“‚ Frontend Files (Aligned with Backend)
â”œâ”€â”€ tagsApi.ts          â†’ ONE service with TWO responsibilities
â”‚   â”œâ”€â”€ Tag Management (create, update, delete tags)
â”‚   â””â”€â”€ Position Tagging (add/remove tags from positions)
â””â”€â”€ hooks/
    â”œâ”€â”€ useTags.ts      â†’ Tag lifecycle management
    â””â”€â”€ usePositionTags.ts â†’ Position-tag operations
```

### Why Three Backend Files?

This is **standard 3-tier architecture**:

1. **`position_tags.py`** (API Layer) - Handles position-tag relationships
   - Endpoints: `/api/v1/positions/{id}/tags`
   - Operations: Add/remove tags from positions
   - **Router prefix**: `/positions`

2. **`tags.py`** (API Layer) - Handles tag management + reverse lookups
   - Endpoints: `/api/v1/tags/`
   - Operations: Create/update/delete tags, find positions by tag
   - **Router prefix**: `/tags`
   - **Includes**: `GET /tags/{id}/positions` (reverse lookup - finds positions with a tag)

3. **`tags_v2.py`** (Data Layer) - Database models
   - Models: `TagV2`, `PositionTag`
   - Relationships: Direct position tagging (strategy relationships removed October 2025)

### Quick Decision Tree

```
â”Œâ”€ Need to create/manage tags?
â”‚  â””â”€â†’ Use /api/v1/tags/ (tags.py)
â”‚
â”œâ”€ Need to add/remove tags from positions?
â”‚  â””â”€â†’ Use /api/v1/positions/{id}/tags (position_tags.py)
â”‚
â””â”€ Need to find all positions with a specific tag?
   â””â”€â†’ Use /api/v1/tags/{id}/positions (tags.py - reverse lookup)
```

This architecture is **intentional and correct** - not technical debt!

ğŸ“š **For complete architecture details**, see: `backend/TAGGING_ARCHITECTURE.md`
