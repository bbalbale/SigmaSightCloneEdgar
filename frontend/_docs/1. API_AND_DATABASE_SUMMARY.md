# SigmaSight API and Database Summary

**Generated**: September 29, 2025
**Last Updated**: November 2, 2025
**Status**: Production-Ready APIs with Complete Database Schema
**Latest Updates**:
- **November 2, 2025**: Added 4 new fundamental data API endpoints (income-statement, balance-sheet, cash-flow, analyst-estimates) - Phase 5 complete
- **October 7, 2025 (Phase 10.1-10.2)**: Railway cron hardening - removed 4x market data duplication, added critical vs non-critical job failure detection
- **October 7, 2025 (Phase 9.1-9.2)**: Company profile sync integrated into Railway cron workflow (daily automatic sync at 11:30 PM UTC)
- **October 7, 2025 (Phase 9.0)**: Complete rewrite of company profile fetcher - async-safe, batching, retry logic, timezone-aware timestamps
- **October 6, 2025 (PM)**: Fixed tag endpoint documentation - corrected count (9â†’7 endpoints), removed non-existent endpoints, updated reverse lookup path to `/tags/{tag_id}/positions`
- **October 6, 2025**: Added Admin Batch Processing endpoints (6 new endpoints for batch control and monitoring)
- **October 5, 2025**: Removed `/strategies` API + strategy tables; position tagging now the sole grouping mechanism
- **October 4, 2025**: Added `company_profiles` table with company names, sectors, industry data, and revenue/earnings estimates
- **October 3, 2025**: Added TAGGING_ARCHITECTURE.md guide - clarifies 3-file structure is intentional design
- **October 2, 2025**: Position tagging system implemented (replaces strategy-based tagging)
- **October 1, 2025**: Added strategy categorization (direction & primary_investment_class), implemented Combination View toggle

---

## ğŸ—ï¸ Tagging System Architecture Clarification

> **IMPORTANT**: The tagging system uses a **3-file architecture** that may appear to be "different services by different developers" - **this is intentional design**, not technical debt!

### Architecture Overview

```
ğŸ“‚ Backend Files (3-Tier Separation of Concerns)
â”œâ”€â”€ position_tags.py    â†’ Position-Tag Relationship Operations
â”œâ”€â”€ tags.py             â†’ Tag Management + Reverse Lookups
â””â”€â”€ tags_v2.py          â†’ Database Models

ğŸ“‚ Frontend Files (Aligned with Backend)
â”œâ”€â”€ tagsApi.ts          â†’ ONE service with TWO responsibilities
â”‚   â”œâ”€â”€ Tag Management (create, update, delete tags)
â”‚   â””â”€â”€ Position Tagging (add/remove tags from positions)
â””â”€â”€ hooks/
    â”œâ”€â”€ useTags.ts      â†’ Tag lifecycle management
    â””â”€â”€ usePositionTags.ts â†’ Position-tag operations
```

### Why Three Backend Files?

This is **standard 3-tier architecture**:

1. **`position_tags.py`** (API Layer) - Handles position-tag relationships
   - Endpoints: `/api/v1/positions/{id}/tags`
   - Operations: Add/remove tags from positions
   - **Router prefix**: `/positions`

2. **`tags.py`** (API Layer) - Handles tag management + reverse lookups
   - Endpoints: `/api/v1/tags/`
   - Operations: Create/update/delete tags, find positions by tag
   - **Router prefix**: `/tags`
   - **Includes**: `GET /tags/{id}/positions` (reverse lookup - finds positions with a tag)

3. **`tags_v2.py`** (Data Layer) - Database models
   - Models: `TagV2`, `PositionTag`
   - Relationships: Direct position tagging (strategy relationships removed October 2025)

### Why is `/tags/{id}/positions` in tags.py?

**This is a REST API design pattern for many-to-many relationships:**

- **Position-centric endpoint** (`position_tags.py`): "What tags does THIS position have?"
  - `GET /positions/{id}/tags` â†’ Returns tags for a position

- **Tag-centric endpoint** (`tags.py`): "What positions have THIS tag?"
  - `GET /tags/{id}/positions` â†’ Returns positions with this tag (reverse lookup)

This follows standard REST conventions and keeps related operations together.

### Quick Decision Tree

```
â”Œâ”€ Need to create/manage tags?
â”‚  â””â”€â†’ Use /api/v1/tags/ (tags.py)
â”‚
â”œâ”€ Need to add/remove tags from positions?
â”‚  â””â”€â†’ Use /api/v1/positions/{id}/tags (position_tags.py)
â”‚
â””â”€ Need to find all positions with a specific tag?
   â””â”€â†’ Use /api/v1/tags/{id}/positions (tags.py - reverse lookup)
```

### Frontend Integration

**ONE service file (`tagsApi.ts`) with TWO logical groups**:

```typescript
// Tag Management (lines 10-62)
tagsApi.create()      // POST /api/v1/tags/
tagsApi.list()        // GET /api/v1/tags/
tagsApi.update()      // PATCH /api/v1/tags/{id}

// Position Tagging (lines 69-130)
tagsApi.addPositionTags()      // POST /api/v1/positions/{id}/tags
tagsApi.removePositionTags()   // POST /api/v1/positions/{id}/tags/remove
tagsApi.getPositionsByTag()    // GET /api/v1/tags/{id}/positions
```

This architecture is **intentional and correct** - not technical debt!

ğŸ“š **For complete architecture details**, see: `backend/TAGGING_ARCHITECTURE.md`

---

## Part I: API Endpoints Summary

### Base URL
```
http://localhost:8000/api/v1
```

### Authentication Required
All endpoints except `/auth/login` and `/auth/register` require JWT Bearer token:
```
Authorization: Bearer <jwt_token>
```

---

## ğŸ“ API Endpoints by Category

### ğŸ” Authentication Endpoints (5 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/auth/login` | âœ… Ready | Login with email/password, returns JWT |
| POST | `/auth/register` | âœ… Ready | Register new user |
| GET | `/auth/me` | âœ… Ready | Get current user info |
| POST | `/auth/refresh` | âœ… Ready | Refresh JWT token |
| POST | `/auth/logout` | âœ… Ready | Clear auth cookie |

### ğŸ“Š Data Endpoints (11 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/data/portfolios` | âœ… Ready | List user portfolios |
| GET | `/data/portfolio/{id}/complete` | âœ… Ready | Full portfolio snapshot |
| GET | `/data/portfolio/{id}/data-quality` | âœ… Ready | Data quality metrics |
| GET | `/data/positions/details` | âœ… Ready | Position details with P&L, investment_class, options data, and **company names** |
| GET | `/data/positions/top/{id}` | âœ… Ready | Top positions by various metrics |
| GET | `/data/prices/historical/{id}` | âœ… Ready | Historical price data |
| GET | `/data/prices/quotes` | âœ… Ready | Real-time market quotes |
| GET | `/data/factors/etf-prices` | âœ… Ready | Factor ETF prices |
| GET | `/data/test-demo` | âœ… Ready | Test endpoint |
| GET | `/data/demo/{portfolio_type}` | âœ… Ready | Demo data (no auth) |

### ğŸ“ˆ Analytics Endpoints (10 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/analytics/portfolio/{id}/overview` | âœ… Ready | Portfolio metrics overview |
| GET | `/analytics/portfolio/{id}/correlation-matrix` | âœ… Ready | Position correlations |
| GET | `/analytics/portfolio/{id}/diversification-score` | âœ… Ready | Portfolio diversification |
| GET | `/analytics/portfolio/{id}/factor-exposures` | âœ… Ready | Portfolio factor betas |
| GET | `/analytics/portfolio/{id}/positions/factor-exposures` | âœ… Ready | Position-level factors |
| GET | `/analytics/portfolio/{id}/stress-test` | âœ… Ready | Stress test scenarios |
| GET | `/analytics/portfolio/{id}/sector-exposure` | âœ… Ready | Sector exposure vs S&P 500 âœ¨ **NEW** (Phase 1: Risk Metrics) |
| GET | `/analytics/portfolio/{id}/concentration` | âœ… Ready | Concentration metrics (HHI, effective positions) âœ¨ **NEW** (Phase 1: Risk Metrics) |
| GET | `/analytics/portfolio/{id}/volatility` | âœ… Ready | Volatility analytics with HAR forecasting âœ¨ **NEW** (Phase 2: Risk Metrics) |
| GET | `/analytics/portfolio/{id}/risk-metrics` | âš ï¸ Deprecated | Legacy risk metrics |

**Risk Metrics Phase 1 Endpoints** âœ¨ **NEW - October 17, 2025**

#### Sector Exposure (`/analytics/portfolio/{id}/sector-exposure`)
Returns portfolio sector weights vs S&P 500 benchmark with over/underweight analysis.

**Response Fields**:
- **available**: Whether sector exposure data is available
- **portfolio_id**: Portfolio UUID
- **calculation_date**: ISO date of calculation
- **data**: Sector exposure metrics
  - **portfolio_weights**: Portfolio sector weights (0-1, sum to 1.0)
  - **benchmark_weights**: S&P 500 sector weights (0-1, sum to 1.0)
  - **over_underweight**: Difference (portfolio - benchmark)
  - **largest_overweight**: Sector with largest overweight
  - **largest_underweight**: Sector with largest underweight
  - **total_portfolio_value**: Total portfolio value used
  - **positions_by_sector**: Position count per sector
  - **unclassified_value**: Value of positions without sector data
  - **unclassified_count**: Count of positions without sector data
- **metadata**: Benchmark info (e.g., "SP500")

**Example**:
```json
{
  "available": true,
  "portfolio_id": "c0510ab8-c6b5-433c-adbc-3f74e1dbdb5e",
  "calculation_date": "2025-10-17",
  "data": {
    "portfolio_weights": {
      "Technology": 0.45,
      "Healthcare": 0.20,
      "Financials": 0.15
    },
    "benchmark_weights": {
      "Technology": 0.28,
      "Healthcare": 0.13,
      "Financials": 0.11
    },
    "over_underweight": {
      "Technology": 0.17,  // 17% overweight vs benchmark
      "Healthcare": 0.07,  // 7% overweight
      "Financials": 0.04   // 4% overweight
    },
    "largest_overweight": "Technology",
    "largest_underweight": "Energy",
    "total_portfolio_value": 1250000.00,
    "positions_by_sector": {
      "Technology": 8,
      "Healthcare": 4,
      "Financials": 3
    },
    "unclassified_value": 0.0,
    "unclassified_count": 0
  },
  "metadata": {
    "benchmark": "SP500"
  }
}
```

**Data Source**: GICS sector classifications from `market_data_cache` table

#### Concentration Metrics (`/analytics/portfolio/{id}/concentration`)
Returns concentration and diversification metrics for portfolio positions.

**Response Fields**:
- **available**: Whether concentration metrics are available
- **portfolio_id**: Portfolio UUID
- **calculation_date**: ISO date of calculation
- **data**: Concentration metrics
  - **hhi**: Herfindahl-Hirschman Index (0-10000, higher = more concentrated)
  - **effective_num_positions**: Effective number of positions (10000 / HHI)
  - **top_3_concentration**: Sum of top 3 position weights (0-1)
  - **top_10_concentration**: Sum of top 10 position weights (0-1)
  - **total_positions**: Total number of active positions
  - **position_weights**: Individual position weights (null for cleaner response)
- **metadata**: Calculation details and interpretation

**HHI Interpretation**:
- **HHI > 2500**: Highly concentrated portfolio
- **HHI 1500-2500**: Moderately concentrated
- **HHI < 1500**: Well diversified

**Example**:
```json
{
  "available": true,
  "portfolio_id": "c0510ab8-c6b5-433c-adbc-3f74e1dbdb5e",
  "calculation_date": "2025-10-17",
  "data": {
    "hhi": 625.0,                      // Well diversified
    "effective_num_positions": 16.0,   // Portfolio effectively has 16 equal-weight positions
    "top_3_concentration": 0.35,       // Top 3 positions = 35% of portfolio
    "top_10_concentration": 0.75,      // Top 10 positions = 75% of portfolio
    "total_positions": 21,
    "position_weights": null
  },
  "metadata": {
    "calculation_method": "market_value_weighted",
    "interpretation": "Well diversified (HHI < 1500)"
  }
}
```

**Implementation Notes**:
- Integrated into batch orchestrator (runs daily with other calculations)
- Data persisted in `portfolio_snapshots` table (sector_exposure, hhi, effective_num_positions, top_3_concentration, top_10_concentration)
- Real-time calculation on-demand via API endpoints
- Graceful degradation if sector data unavailable
- Part of Risk Metrics Phase 1 implementation (October 2025)

#### Volatility Metrics (`/analytics/portfolio/{id}/volatility`)
Returns portfolio volatility analytics with HAR (Heterogeneous Autoregressive) forecasting model.

**Response Fields**:
- **available**: Whether volatility metrics are available
- **portfolio_id**: Portfolio UUID
- **calculation_date**: ISO date of calculation
- **data**: Volatility metrics
  - **realized_volatility_21d**: 21-day (~1 month) realized volatility (0-1 scale, annualized)
  - **realized_volatility_63d**: 63-day (~3 months) realized volatility (0-1 scale, annualized)
  - **expected_volatility_21d**: HAR model forecast for next 21 trading days (null if insufficient data)
  - **volatility_trend**: Direction of volatility change ('increasing', 'decreasing', 'stable', null)
  - **volatility_percentile**: Current volatility vs 1-year historical distribution (0-1 scale, null if insufficient history)
- **metadata**: Calculation details
  - **forecast_model**: Model used for predictions (e.g., "HAR")
  - **trading_day_windows**: Window specification (e.g., "21d/63d trading days")
  - **error**: Error message if calculation failed

**Volatility Interpretation**:
- **< 15%**: Very Low volatility (stable portfolio)
- **15-25%**: Low volatility (typical for diversified portfolios)
- **25-35%**: Moderate volatility (typical for growth portfolios)
- **35-50%**: High volatility (aggressive/concentrated positions)
- **> 50%**: Very High volatility (speculative/leveraged)

**HAR Model Details**:
- Uses daily, weekly (5d), and monthly (21d) volatility components
- Forecasts next 21 trading days (~1 month)
- Requires sufficient historical data (minimum 63 trading days)
- Automatically handles weekends and market holidays

**Example**:
```json
{
  "available": true,
  "portfolio_id": "c0510ab8-c6b5-433c-adbc-3f74e1dbdb5e",
  "calculation_date": "2025-10-17",
  "data": {
    "realized_volatility_21d": 0.18,        // 18% annualized volatility (Low)
    "realized_volatility_63d": 0.22,        // 22% annualized volatility (Low)
    "expected_volatility_21d": 0.19,        // HAR forecast: 19% next month
    "volatility_trend": "decreasing",       // Volatility is decreasing
    "volatility_percentile": 0.35           // 35th percentile vs 1-year history
  },
  "metadata": {
    "forecast_model": "HAR",
    "trading_day_windows": "21d/63d trading days"
  }
}
```

**Data Source**: Daily portfolio returns from `portfolio_snapshots` table

**Implementation Notes**:
- Integrated into batch orchestrator as job #10 (runs daily after portfolio_aggregation)
- Data persisted in `portfolio_snapshots` table (realized_volatility_21d, realized_volatility_63d, expected_volatility_21d, volatility_trend, volatility_percentile)
- Uses trading day windows (21/63 days), not calendar days
- Automatically excludes weekends and market holidays from calculations
- Graceful degradation if insufficient historical data (returns null for forecast)
- Part of Risk Metrics Phase 2 implementation (October 2025)
- Backend endpoint: `backend/app/api/v1/analytics/portfolio.py:562-651`
- Calculation engine: `backend/app/calculations/volatility_analytics.py`

### ğŸ’¬ Chat Endpoints (6 endpoints - SSE Streaming)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/chat/conversations` | âœ… Ready | Create conversation |
| GET | `/chat/conversations/{id}` | âœ… Ready | Get conversation |
| GET | `/chat/conversations` | âœ… Ready | List conversations |
| PUT | `/chat/conversations/{id}/mode` | âœ… Ready | Change agent mode |
| DELETE | `/chat/conversations/{id}` | âœ… Ready | Delete conversation |
| POST | `/chat/send` | âœ… Ready | Send message (SSE stream) |

### ğŸ¯ Target Prices Endpoints (10 endpoints)
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/target-prices/{portfolio_id}` | âœ… Ready | Create target price |
| GET | `/target-prices/{portfolio_id}` | âœ… Ready | List portfolio targets |
| GET | `/target-prices/{portfolio_id}/summary` | âœ… Ready | Portfolio summary |
| GET | `/target-prices/target/{id}` | âœ… Ready | Get specific target |
| PUT | `/target-prices/target/{id}` | âœ… Ready | Update target price |
| DELETE | `/target-prices/target/{id}` | âœ… Ready | Delete target price |
| POST | `/target-prices/{portfolio_id}/bulk` | âœ… Ready | Bulk create |
| PUT | `/target-prices/{portfolio_id}/bulk-update` | âœ… Ready | Bulk update |
| POST | `/target-prices/{portfolio_id}/import-csv` | âœ… Ready | Import from CSV |
| POST | `/target-prices/{portfolio_id}/export` | âœ… Ready | Export to CSV/JSON |

### ğŸ¯ Strategy Endpoints (Removed October 2025)

The strategy system (backend APIs, database tables, and frontend services) has been **fully decommissioned**. All grouping, filtering, and categorization should flow through tags + position tagging and portfolio analytics.

**What Changed**:
- `/api/v1/strategies/*` routes removed from backend
- `Strategy*` SQLAlchemy models and Alembic tables dropped
- `strategiesApi.ts`, Combination View, and related components slated for removal/refactor

**Migration Guidance**:
1. Use `tagsApi` + `positionTagsApi` for all organizational UX
2. Replace Combination View with tag-driven layouts (see Tagging Architecture docs)
3. Remove strategy-specific UI components during Organize page redesign

ğŸ“Œ See `backend/TODO4.md` Section "Phase 3.0: Strategy System Sunset Plan" for backend rationale and migration checklist.

### ğŸ·ï¸ Tag Management Endpoints (7 endpoints) - **Frontend: 100% Complete** âœ…
| Method | Endpoint | Status | Description | Frontend Method |
|--------|----------|--------|-------------|-----------------|
| POST | `/tags/` | âœ… Ready | Create new tag | `tagsApi.create()` |
| GET | `/tags/` | âœ… Ready | List user tags | `tagsApi.list()` |
| GET | `/tags/{id}` | âœ… Ready | Get tag details | `tagsApi.get()` |
| PATCH | `/tags/{id}` | âœ… Ready | Update tag | `tagsApi.update()` |
| POST | `/tags/{id}/archive` | âœ… Ready | Archive tag (soft delete) | `tagsApi.delete()` |
| POST | `/tags/{id}/restore` | âœ… Ready | Restore archived tag | `tagsApi.restore()` |
| POST | `/tags/defaults` | âœ… Ready | Create/get default tags (idempotent) | `tagsApi.defaults()` |

**Frontend Service**: `src/services/tagsApi.ts` (7 tag management methods + 5 position tagging methods)

### ğŸ·ï¸ Position Tagging Endpoints (5 endpoints) - **NEW** âœ… **Preferred Method**
| Method | Endpoint | Status | Description | Frontend Method |
|--------|----------|--------|-------------|-----------------|
| POST | `/positions/{id}/tags` | âœ… Ready | Add tags to position | `tagsApi.addPositionTags()` |
| DELETE | `/positions/{id}/tags` | âœ… Ready | Remove tags from position | `tagsApi.removePositionTags()` |
| GET | `/positions/{id}/tags` | âœ… Ready | Get position's tags | `tagsApi.getPositionTags()` |
| PATCH | `/positions/{id}/tags` | âœ… Ready | Replace all position tags | `tagsApi.replacePositionTags()` |
| GET | `/tags/{tag_id}/positions` | âœ… Ready | Get positions by tag (reverse lookup) | `tagsApi.getPositionsByTag()` |

**Frontend Service**: `src/services/tagsApi.ts` (same service, 5 new methods added)
**React Hook**: `src/hooks/usePositionTags.ts` - State management for position tagging

**Key Features**:
- **Direct Tagging**: Tag positions directly without creating strategies
- **Multiple Tags**: Positions can have multiple tags for flexible organization
- **Batch Operations**: Add/remove multiple tags in a single request
- **Automatic Inclusion**: Position details endpoint now includes `tags` array
- **Performance Optimized**: Batch fetching to prevent N+1 queries

### âš™ï¸ Admin Batch Processing Endpoints (6 endpoints) âœ¨ **NEW - October 6, 2025**
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| POST | `/admin/batch/run` | âœ… Ready | Trigger batch processing with real-time tracking |
| GET | `/admin/batch/run/current` | âœ… Ready | Get current batch status (polling endpoint) |
| POST | `/admin/batch/trigger/market-data` | âœ… Ready | Manually trigger market data update |
| POST | `/admin/batch/trigger/correlations` | âœ… Ready | Manually trigger correlation calculations |
| GET | `/admin/batch/data-quality` | âœ… Ready | Get data quality status and metrics |
| POST | `/admin/batch/data-quality/refresh` | âœ… Ready | Refresh market data for quality improvement |

**Company Profile Sync** âš ï¸ **DEPRECATED - Now Automatic** (Phase 9.1 - October 7, 2025)
- **Endpoint**: `POST /admin/batch/trigger/company-profiles`
- **Status**: âš ï¸ **DEPRECATED** - Company profiles now sync **automatically** via Railway cron
- **Schedule**: Daily at 11:30 PM UTC (6:30 PM EST / 7:30 PM EDT) on trading days
- **Manual sync still available** for emergency use, but no longer needed for normal operations
- **Workflow**: Railway cron runs company profile sync (Step 1) before batch calculations (Step 2)

**Key Features**:
- **Real-time Monitoring**: Poll `/admin/batch/run/current` every 2-5 seconds for progress
- **Concurrent Run Prevention**: 409 Conflict if batch already running (use `force=true` to override)
- **In-Memory Tracking**: Lightweight status tracking without database overhead
- **Targeted Operations**: Separate endpoints for market data sync and correlation calculations
- **Automated Company Profiles** (Phase 9.1): Daily sync at 11:30 PM UTC via Railway cron

### ğŸ¢ Company Profiles Endpoint (1 endpoint) âœ¨ **Phase 9.0 - October 7, 2025**
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/data/company-profiles` | âœ… Ready | Get company profiles with 53+ fields (flexible query modes) |

### ğŸ“Š Fundamental Data Endpoints (4 endpoints) âœ¨ **NEW - November 2, 2025**
| Method | Endpoint | Status | Description |
|--------|----------|--------|-------------|
| GET | `/fundamentals/{symbol}/income-statement` | âœ… Ready | Get income statements (revenue, margins, EPS) |
| GET | `/fundamentals/{symbol}/balance-sheet` | âœ… Ready | Get balance sheets (assets, liabilities, equity) |
| GET | `/fundamentals/{symbol}/cash-flow` | âœ… Ready | Get cash flows (operating CF, FCF, CapEx) |
| GET | `/fundamentals/{symbol}/analyst-estimates` | âœ… Ready | Get analyst estimates (4 periods: 0q, +1q, 0y, +1y) |

**Data Source**: Financial statements stored in database (populated by batch orchestrator Phase 1.5)

**Implementation**:
- **Backend**: `app/api/v1/fundamentals.py` (270 lines, 4 endpoints)
- **Database**: `income_statements`, `balance_sheets`, `cash_flows` tables
- **Schemas**: `app/schemas/fundamentals.py` (simplified response models with direct DB mapping)
- **Router**: Registered in `app/api/v1/router.py` with `/fundamentals` prefix

#### 1. Income Statement Endpoint
**Path**: `GET /api/v1/fundamentals/{symbol}/income-statement`

**Query Parameters**:
- `periods` (default: 4, range: 1-20) - Number of periods to return
- `frequency` (default: "q", options: "q" or "a") - Quarterly or annual

**Response Fields** (22 financial fields per period):
- **Period Info**: period_date, frequency, fiscal_year, fiscal_quarter
- **Revenue & Costs**: total_revenue, cost_of_revenue, gross_profit, gross_margin (calculated)
- **Operating Expenses**: research_and_development, selling_general_and_administrative
- **Operating Results**: operating_income, operating_margin (calculated), ebit, ebitda
- **Net Income**: net_income, net_margin (calculated), diluted_eps, basic_eps
- **Share Counts**: basic_average_shares, diluted_average_shares (BIGINT for large cap stocks)
- **Tax & Interest**: tax_provision, interest_expense, depreciation_and_amortization

**Example Request**:
```
GET /api/v1/fundamentals/MSFT/income-statement?periods=1&frequency=q
```

**Example Response**:
```json
{
  "symbol": "MSFT",
  "frequency": "q",
  "currency": "USD",
  "periods_returned": 1,
  "periods": [{
    "period_date": "2025-06-30",
    "frequency": "q",
    "fiscal_year": 2025,
    "fiscal_quarter": 4,
    "total_revenue": "281724000000.00",
    "cost_of_revenue": "65863000000.00",
    "gross_profit": "215861000000.00",
    "gross_margin": "0.766200",
    "operating_income": "128542000000.00",
    "operating_margin": "0.456200",
    "net_income": "101832000000.00",
    "net_margin": "0.361500",
    "diluted_eps": "13.6400",
    "basic_average_shares": "7427000000",
    "diluted_average_shares": "7464000000"
  }]
}
```

#### 2. Balance Sheet Endpoint
**Path**: `GET /api/v1/fundamentals/{symbol}/balance-sheet`

**Query Parameters**:
- `periods` (default: 4, range: 1-20)
- `frequency` (default: "q", options: "q" or "a")

**Response Fields** (29 financial fields per period):
- **Period Info**: period_date, frequency, fiscal_year, fiscal_quarter
- **Assets**: total_assets, current_assets, cash_and_cash_equivalents, cash_and_short_term_investments, accounts_receivable, inventory
- **Liabilities**: total_liabilities, current_liabilities, accounts_payable, short_term_debt, long_term_debt, total_debt
- **Equity**: total_stockholders_equity, retained_earnings, common_stock
- **Calculated Metrics**: working_capital, net_debt, current_ratio, debt_to_equity

**Example Request**:
```
GET /api/v1/fundamentals/MSFT/balance-sheet?periods=1&frequency=q
```

**Example Response**:
```json
{
  "symbol": "MSFT",
  "frequency": "q",
  "currency": "USD",
  "periods_returned": 1,
  "periods": [{
    "period_date": "2025-06-30",
    "total_assets": "619003000000.00",
    "current_assets": "227063000000.00",
    "cash_and_cash_equivalents": "30242000000.00",
    "total_liabilities": "275524000000.00",
    "current_liabilities": "137269000000.00",
    "total_debt": "92581000000.00",
    "total_stockholders_equity": "343479000000.00",
    "working_capital": "89794000000.00",
    "net_debt": "-8675000000.00",
    "current_ratio": "1.654000",
    "debt_to_equity": "0.269600"
  }]
}
```

#### 3. Cash Flow Endpoint
**Path**: `GET /api/v1/fundamentals/{symbol}/cash-flow`

**Query Parameters**:
- `periods` (default: 4, range: 1-20)
- `frequency` (default: "q", options: "q" or "a")

**Response Fields** (19 financial fields per period):
- **Period Info**: period_date, frequency, fiscal_year, fiscal_quarter
- **Operating Activities**: operating_cash_flow, stock_based_compensation
- **Investing Activities**: investing_cash_flow, capital_expenditures
- **Financing Activities**: financing_cash_flow, dividends_paid, stock_repurchased, debt_issuance, debt_repayment
- **Net Changes**: net_change_in_cash
- **Calculated Metrics**: free_cash_flow (operating CF - CapEx), fcf_margin (FCF / revenue)

**Example Request**:
```
GET /api/v1/fundamentals/MSFT/cash-flow?periods=1&frequency=q
```

**Example Response**:
```json
{
  "symbol": "MSFT",
  "frequency": "q",
  "currency": "USD",
  "periods_returned": 1,
  "periods": [{
    "period_date": "2025-06-30",
    "operating_cash_flow": "136162000000.00",
    "capital_expenditures": "-64551000000.00",
    "free_cash_flow": "71611000000.00",
    "fcf_margin": "0.254200",
    "investing_cash_flow": "-80447000000.00",
    "financing_cash_flow": "-60046000000.00",
    "net_change_in_cash": "-4331000000.00",
    "dividends_paid": "-25800000000.00",
    "stock_repurchased": "-38200000000.00"
  }]
}
```

#### 4. Analyst Estimates Endpoint
**Path**: `GET /api/v1/fundamentals/{symbol}/analyst-estimates`

**Query Parameters**: None (returns all 4 periods: 0q, +1q, 0y, +1y)

**Response Fields** (24 estimate fields total):
- **Current Quarter (0q)**: eps_avg/low/high, revenue_avg/low/high, analyst_count, target_period_date
- **Next Quarter (+1q)**: eps_avg/low/high, revenue_avg/low/high, analyst_count, target_period_date
- **Current Year (0y)**: earnings_avg/low/high, revenue_avg/low/high, analyst_count, end_date
- **Next Year (+1y)**: earnings_avg/low/high, revenue_avg/low/high, analyst_count, end_date

**Data Source**: `company_profiles` table (updated by batch orchestrator Phase 1.5)

**Example Request**:
```
GET /api/v1/fundamentals/MSFT/analyst-estimates
```

**Example Response**:
```json
{
  "symbol": "MSFT",
  "estimates": {
    "current_quarter_eps_avg": "3.8700",
    "current_quarter_eps_low": "3.7000",
    "current_quarter_eps_high": "4.0100",
    "current_quarter_revenue_avg": "68700000000.00",
    "current_quarter_analyst_count": 34,
    "next_quarter_eps_avg": "3.9200",
    "next_quarter_revenue_avg": "69800000000.00",
    "next_quarter_analyst_count": 32,
    "current_year_earnings_avg": "15.7500",
    "current_year_revenue_avg": "277500000000.00",
    "current_year_analyst_count": 38,
    "next_year_earnings_avg": "18.5700",
    "next_year_revenue_avg": "305400000000.00",
    "next_year_analyst_count": 35
  }
}
```

**Key Features**:
- **Database-backed**: All data stored in database, no on-demand API calls
- **Fast responses**: Sub-10ms query times (50x faster than on-demand fetching)
- **Batch processing**: Data updated daily via batch orchestrator Phase 1.5 (smart fetching based on earnings dates)
- **Query flexibility**: Configurable number of periods and frequency (quarterly/annual)
- **Error handling**: 404 HTTPException when no data found for symbol
- **Sorted results**: All endpoints return periods sorted by date descending (most recent first)

**Testing**: All 4 endpoints tested with MSFT, returning 200 status codes with valid financial data

---

### ğŸ¢ Company Profiles Query Modes

**Query Modes** (exactly one required):
- **symbols**: Direct symbol lookup (e.g., `?symbols=AAPL,MSFT,GOOGL`) - public data, no ownership check
- **position_ids**: Fetch profiles for specific positions (requires ownership)
- **portfolio_id**: Fetch profiles for all portfolio symbols (requires ownership)

**Optional Field Filtering**:
- `?fields=symbol,company_name,sector,industry` - Returns only specified fields for performance optimization
- Default: Returns all 53 fields

**Company Profile Fields** (53 total):
- **Basic Info**: company_name, sector, industry, exchange, country, market_cap, description
- **Company Type**: is_etf, is_fund
- **Company Details**: ceo, employees, website
- **Valuation Metrics**: pe_ratio, forward_pe, dividend_yield, beta, week_52_high, week_52_low
- **Analyst Data**: target_mean_price, target_high_price, target_low_price, number_of_analyst_opinions, recommendation_mean, recommendation_key
- **Forward Estimates**: forward_eps, earnings_growth, revenue_growth, earnings_quarterly_growth
- **Profitability**: profit_margins, operating_margins, gross_margins, return_on_assets, return_on_equity, total_revenue
- **Current Year Estimates**: current_year_revenue_avg, current_year_revenue_low, current_year_revenue_high, current_year_revenue_growth, current_year_earnings_avg, current_year_earnings_low, current_year_earnings_high, current_year_end_date
- **Next Year Estimates**: next_year_revenue_avg, next_year_revenue_low, next_year_revenue_high, next_year_revenue_growth, next_year_earnings_avg, next_year_earnings_low, next_year_earnings_high, next_year_end_date
- **Data Tracking**: data_source, last_updated, created_at, updated_at

**Integration Points**:
- **Position Details**: Company names automatically included in `/data/positions/details` response
- **Batch Fetching**: Optimized batch fetching prevents N+1 queries
- **Automatic Sync**: Railway cron syncs profiles daily at 11:30 PM UTC
- **Data Source**: Hybrid approach using yfinance (basic info) + yahooquery (estimates)

**Example Requests**:
```
GET /data/company-profiles?symbols=AAPL,MSFT
GET /data/company-profiles?portfolio_id=uuid-here
GET /data/company-profiles?position_ids=uuid1,uuid2&fields=symbol,company_name,sector
```

### ğŸ“‹ Summary Statistics
- **Total Endpoints**: 63 endpoints across 10 categories
- **Production Ready**: 63 (100%)
- **Removed (Strategies)**: 12 endpoints removed October 2025
- **Categories**: 10 (Auth, Data, Analytics, Chat, Target Prices, Tags, Position Tagging, Admin Batch Processing, Company Profiles, Fundamentals)

**Endpoint Breakdown**:
- Authentication: 5 endpoints
- Data: 10 endpoints
- Analytics: 9 endpoints âœ¨ **+2 NEW** (sector-exposure, concentration, volatility)
- Chat: 6 endpoints (SSE streaming)
- Target Prices: 10 endpoints
- Tag Management: 7 endpoints
- Position Tagging: 5 endpoints
- Admin Batch Processing: 6 endpoints
- Company Profiles: 1 endpoint
- Fundamental Data: 4 endpoints âœ¨ **NEW** (income-statement, balance-sheet, cash-flow, analyst-estimates)

---

## Part I-B: Frontend Integration Status

### ğŸ¨ Frontend Services Implementation

| Service | File | Methods | Status | Notes |
|---------|------|---------|--------|-------|
| **Position Tagging** | `src/services/tagsApi.ts` | 5/5 | âœ… 100% | **NEW** - Direct position tagging (preferred) |
| **Tags** | `src/services/tagsApi.ts` | 10/10 | âœ… 100% | Full tag lifecycle + bulk operations |
| **Strategies** | `src/services/strategiesApi.ts` | 0/0 | ğŸ—‘ï¸ Removed | Delete service + migrate to tag flows |
| **Analytics** | `src/services/analyticsApi.ts` | 6/6 | âœ… 100% | Portfolio analytics endpoints âœ¨ **+1 NEW** (volatility) |
| **Portfolio** | `src/services/portfolioService.ts` | 1/1 | âœ… 100% | Load portfolio data (composite) |
| **Auth** | `src/services/authManager.ts` | - | âœ… 100% | JWT token management |

### ğŸ§© Frontend Components Implementation

| Component | File | Purpose | Status | Notes |
|-----------|------|---------|--------|-------|
| **usePositionTags** | `src/hooks/usePositionTags.ts` | React hook (NEW) | âœ… Complete | **NEW** - Position tag state management |
| **useTags** | `src/hooks/useTags.ts` | React hook | âœ… Complete | Tag CRUD operations |
| **StrategyCard** | `src/components/strategies/StrategyCard.tsx` | Wrapper for position cards | ğŸ—‘ï¸ Removed | Delete during Organize redesign |
| **StrategyPositionList** | `src/components/strategies/StrategyPositionList.tsx` | List container | ğŸ—‘ï¸ Removed | Delete during Organize redesign |
| **PortfolioStrategiesView** | `src/components/portfolio/PortfolioStrategiesView.tsx` | 3-column layout | ğŸ—‘ï¸ Removed | Retire with strategy UI |
| **TagBadge** | `src/components/organize/TagBadge.tsx` | Tag display | âœ… Complete | Drag-drop support, color customization |
| **useStrategies** | `src/hooks/useStrategies.ts` | React hook | ğŸ—‘ï¸ Removed | Replace with tag-based hooks |
| **useStrategyFiltering** | `src/hooks/useStrategyFiltering.ts` | Filter hook | ğŸ—‘ï¸ Removed | Replace with tag-based filters |

### ğŸ“¦ Type Definitions

| File | Exports | Status | Notes |
|------|---------|--------|-------|
| `src/types/strategies.ts` | 25+ types | ğŸ—‘ï¸ Legacy | Remove after migrating UI to tag-centric types |
| `src/types/analytics.ts` | Factor types | âœ… Complete | FactorExposure, analytics data |

### ğŸš§ Integration Status (Portfolio Page)

| Feature | Status | Notes |
|---------|--------|-------|
| **Strategy display components** | ğŸ—‘ï¸ Removed | Retire with backend strategy sunset |
| **Strategy categorization** | ğŸ—‘ï¸ Removed | Fields no longer returned by API |
| **Strategy filtering** | ğŸ—‘ï¸ Removed | Replace with tag-based filtering |
| **Portfolio page integration** | ğŸ”„ In Progress | Shift to tag-driven layout |
| **Tag filtering UI** | ğŸ”„ Partial | FilterBar exists but doesn't filter yet |
| **Tag management modal** | âŒ Not Started | Needs implementation |
| **Organize page** | ğŸ”„ In Progress | Migrate from strategies to tag groups |

**Recommendation**: Focus on tag + position tagging UX. Remove strategy UI (components/hooks/types) and lean on tag metadata + analytics for grouping. See `backend/TODO4.md` and `strategyuicomponents.md` for transition notes.

---

## Part II: Database Schema - ASCII Diagram

### ğŸ—„ï¸ Database Overview
- **Type**: PostgreSQL (via Docker)
- **ORM**: SQLAlchemy 2.0 with async support
- **Migrations**: Alembic
- **Primary Keys**: UUID for all tables

### ğŸ“Š Core Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SIGMASIGHT DATABASE SCHEMA                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     USERS       â”‚       â”‚   PORTFOLIOS    â”‚       â”‚   POSITIONS     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)    PK â”‚â”€â”€â”€â”   â”‚ id (UUID)    PK â”‚â”€â”€â”€â”   â”‚ id (UUID)    PK â”‚
â”‚ email           â”‚   â”‚   â”‚ user_id      FK â”‚   â”‚   â”‚ portfolio_id FK â”‚
â”‚ hashed_password â”‚   â””â”€â”€<â”‚ name            â”‚   â””â”€â”€<â”‚ symbol          â”‚
â”‚ full_name       â”‚       â”‚ description     â”‚       â”‚ position_type   â”‚
â”‚ is_active       â”‚       â”‚ currency        â”‚       â”‚ quantity        â”‚
â”‚ is_admin        â”‚       â”‚ created_at      â”‚       â”‚ cost_basis      â”‚
â”‚ created_at      â”‚       â”‚ updated_at      â”‚       â”‚ created_at      â”‚
â”‚ updated_at      â”‚       â”‚ cash_balance    â”‚       â”‚ updated_at      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ equity_balance  â”‚       â”‚ investment_classâ”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚                        â”‚
                                    â”‚                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                                    â”‚
                    â–¼                                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ PORTFOLIO_SNAPSHOTS â”‚                           â”‚  MARKET_DATA_CACHE   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ id (UUID)        PK â”‚                           â”‚ id (UUID)         PK â”‚
        â”‚ portfolio_id     FK â”‚                           â”‚ symbol               â”‚
        â”‚ snapshot_date       â”‚                           â”‚ date                 â”‚
        â”‚ total_value         â”‚                           â”‚ open                 â”‚
        â”‚ daily_return        â”‚                           â”‚ high                 â”‚
        â”‚ cumulative_return   â”‚                           â”‚ low                  â”‚
        â”‚ created_at          â”‚                           â”‚ close                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚ volume               â”‚
                                                          â”‚ adjusted_close       â”‚
                                                          â”‚ created_at           â”‚
                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   COMPANY_PROFILES (53 fields)   â”‚
                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                    â”‚ symbol (PK)                     UNIQUEâ”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Basic Info â”€â”€                     â”‚
                                    â”‚ company_name, sector, industry       â”‚
                                    â”‚ exchange, country, market_cap        â”‚
                                    â”‚ description, website                 â”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Company Type â”€â”€                   â”‚
                                    â”‚ is_etf, is_fund                      â”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Company Details â”€â”€                â”‚
                                    â”‚ ceo, employees                       â”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Valuation Metrics â”€â”€              â”‚
                                    â”‚ pe_ratio, forward_pe, dividend_yield â”‚
                                    â”‚ beta, week_52_high, week_52_low      â”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Analyst Data â”€â”€                   â”‚
                                    â”‚ target_mean_price, target_high_price â”‚
                                    â”‚ target_low_price                     â”‚
                                    â”‚ number_of_analyst_opinions           â”‚
                                    â”‚ recommendation_mean, recommendation_keyâ”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Forward Estimates â”€â”€              â”‚
                                    â”‚ forward_eps, earnings_growth         â”‚
                                    â”‚ revenue_growth                       â”‚
                                    â”‚ earnings_quarterly_growth            â”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Profitability Metrics â”€â”€          â”‚
                                    â”‚ profit_margins, operating_margins    â”‚
                                    â”‚ gross_margins, return_on_assets      â”‚
                                    â”‚ return_on_equity, total_revenue      â”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Current Year (0y) â”€â”€              â”‚
                                    â”‚ current_year_revenue_avg/_low/_high  â”‚
                                    â”‚ current_year_revenue_growth          â”‚
                                    â”‚ current_year_earnings_avg/_low/_high â”‚
                                    â”‚ current_year_end_date                â”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Next Year (+1y) â”€â”€                â”‚
                                    â”‚ next_year_revenue_avg/_low/_high     â”‚
                                    â”‚ next_year_revenue_growth             â”‚
                                    â”‚ next_year_earnings_avg/_low/_high    â”‚
                                    â”‚ next_year_end_date                   â”‚
                                    â”‚                                      â”‚
                                    â”‚ â”€â”€ Data Tracking â”€â”€                  â”‚
                                    â”‚ data_source (yfinance+yahooquery)    â”‚
                                    â”‚ last_updated, created_at, updated_at â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â”‚ Many-to-One (via symbol)
                                                    â–¼
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚  POSITIONS  â”‚
                                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                              â”‚ symbol      â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CALCULATION RESULTS TABLES                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   POSITION_GREEKS    â”‚  â”‚  FACTOR_EXPOSURES    â”‚  â”‚ CORRELATION_CALCS    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ position_id       FK â”‚  â”‚ portfolio_id      FK â”‚  â”‚ portfolio_id      FK â”‚
â”‚ calculation_date     â”‚  â”‚ factor_id         FK â”‚  â”‚ calculation_date     â”‚
â”‚ delta                â”‚  â”‚ calculation_date     â”‚  â”‚ lookback_days        â”‚
â”‚ gamma                â”‚  â”‚ exposure_value       â”‚  â”‚ created_at           â”‚
â”‚ theta                â”‚  â”‚ beta                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ vega                 â”‚  â”‚ created_at           â”‚            â”‚
â”‚ rho                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚ created_at           â”‚                                       â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   PAIRWISE_CORRELATIONS          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POSITION_FACTOR_EXP  â”‚            â”‚ id (UUID)                     PK â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚ correlation_calc_id           FK â”‚
â”‚ id (UUID)         PK â”‚            â”‚ symbol1                          â”‚
â”‚ position_id       FK â”‚            â”‚ symbol2                          â”‚
â”‚ factor_id         FK â”‚            â”‚ correlation_value                â”‚
â”‚ calculation_date     â”‚            â”‚ overlap_days                     â”‚
â”‚ exposure_value       â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ created_at           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STRESS TEST & RISK TABLES                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STRESS_SCENARIOS    â”‚  â”‚  STRESS_TEST_RESULTS â”‚  â”‚    BATCH_JOBS        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚  â”‚ id (UUID)         PK â”‚
â”‚ scenario_id          â”‚  â”‚ portfolio_id      FK â”‚  â”‚ job_name             â”‚
â”‚ name                 â”‚  â”‚ scenario_id       FK â”‚  â”‚ status               â”‚
â”‚ description          â”‚  â”‚ calculation_date     â”‚  â”‚ portfolio_id      FK â”‚
â”‚ category             â”‚  â”‚ correlated_pnl       â”‚  â”‚ started_at           â”‚
â”‚ market_shock         â”‚  â”‚ independent_pnl      â”‚  â”‚ completed_at         â”‚
â”‚ created_at           â”‚  â”‚ created_at           â”‚  â”‚ error_message        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            TARGET PRICE TABLES                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PORTFOLIO_TARGET_PRICES   â”‚         â”‚   FACTOR_DEFINITIONS       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)               PK â”‚         â”‚ id (UUID)               PK â”‚
â”‚ portfolio_id            FK â”‚         â”‚ name                       â”‚
â”‚ position_id             FK â”‚         â”‚ etf_symbol                 â”‚
â”‚ symbol                     â”‚         â”‚ description                â”‚
â”‚ position_type              â”‚         â”‚ is_active                  â”‚
â”‚ target_price_eoy           â”‚         â”‚ created_at                 â”‚
â”‚ target_price_next_year     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ downside_target_price      â”‚
â”‚ current_price              â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ expected_return_eoy        â”‚         â”‚    ECONOMIC_DATA           â”‚
â”‚ expected_return_next_year  â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ downside_return            â”‚         â”‚ id (UUID)               PK â”‚
â”‚ position_weight            â”‚         â”‚ indicator                  â”‚
â”‚ contribution_to_portfolio  â”‚         â”‚ date                       â”‚
â”‚ contribution_to_risk       â”‚         â”‚ value                      â”‚
â”‚ price_updated_at           â”‚         â”‚ source                     â”‚
â”‚ created_by              FK â”‚         â”‚ created_at                 â”‚
â”‚ created_at                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ updated_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TAGGING SYSTEM TABLES                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚       TAGS_V2              â”‚
                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              â”‚ id (UUID)               PK â”‚
                              â”‚ user_id                 FK â”‚
                              â”‚ name                       â”‚
                              â”‚ color                      â”‚
                              â”‚ description                â”‚
                              â”‚ display_order              â”‚
                              â”‚ usage_count                â”‚
                              â”‚ is_archived                â”‚
                              â”‚ archived_at                â”‚
                              â”‚ archived_by             FK â”‚
                              â”‚ created_at                 â”‚
                              â”‚ updated_at                 â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     POSITION_TAGS          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)               PK â”‚
â”‚ position_id             FK â”‚
â”‚ tag_id                  FK â”‚
â”‚ assigned_at                â”‚
â”‚ assigned_by             FK â”‚
â”‚ UNIQUE(position_id, tag_id)â”‚
â”‚ INDEX(position_id)         â”‚
â”‚ INDEX(tag_id)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   POSITIONS     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)    PK â”‚
â”‚ portfolio_id FK â”‚
â”‚ symbol          â”‚
â”‚ position_type   â”‚
â”‚ quantity        â”‚
â”‚ investment_classâ”‚
â”‚ created_at      â”‚
â”‚ updated_at      â”‚
â”‚ tags (computed) â”‚ â† Batch fetched via position_tags
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Key Changes (October 2025)**:
- Strategy tables removed; `position_tags` is the canonical tagging junction table
- All grouping/filtering flows through tags + position tagging APIs
- Tag usage counts reflect direct position-tag assignments only

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OPTION_CONTRACTS         â”‚         â”‚   POSITION_FACTOR_EXP      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)               PK â”‚         â”‚ id (UUID)               PK â”‚
â”‚ position_id             FK â”‚         â”‚ position_id             FK â”‚
â”‚ underlying_symbol          â”‚         â”‚ factor_id               FK â”‚
â”‚ strike_price               â”‚         â”‚ calculation_date           â”‚
â”‚ expiry_date                â”‚         â”‚ exposure_value             â”‚
â”‚ option_type                â”‚         â”‚ created_at                 â”‚
â”‚ contract_size              â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ break_even_points          â”‚
â”‚ created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AGENT/CHAT TABLES                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   agent.CONVERSATIONS      â”‚         â”‚  agent.MESSAGES            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)               PK â”‚         â”‚ id (UUID)               PK â”‚
â”‚ user_id                 FK â”‚â”€â”€â”€â”     â”‚ conversation_id         FK â”‚
â”‚ portfolio_id            FK â”‚   â”‚     â”‚ role                       â”‚
â”‚ mode                       â”‚   â””â”€â”€â”€â”€<â”‚ content                    â”‚
â”‚ provider                   â”‚         â”‚ tool_calls                 â”‚
â”‚ provider_thread_id         â”‚         â”‚ created_at                 â”‚
â”‚ created_at                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

### ğŸ”‘ Key Relationships

#### Primary Relationships:
1. **Users â†’ Portfolios**: One-to-Many (1 user has multiple portfolios)
2. **Portfolios â†’ Positions**: One-to-Many (1 portfolio has multiple positions)
3. **Users â†’ Tags**: One-to-Many (user-scoped tagging system)
4. **Tags â†” Positions**: Many-to-Many via `position_tags`
5. **Portfolios â†’ Portfolio Snapshots**: One-to-Many (historical snapshots)
6. **Positions â†’ Greeks/Factors**: One-to-Many (calculation results)
7. **Portfolios â†’ Target Prices**: One-to-Many (price targets per position)
8. **Users â†’ Conversations**: One-to-Many (chat threads)
9. **Conversations â†’ Messages**: One-to-Many (chat history)
10. **Positions â†’ Company Profiles**: Many-to-One via symbol (company metadata lookup)
    - **CompanyProfile.symbol** (PK) â† **Position.symbol** (FK via application logic)
    - Lookups optimized with batch fetching to prevent N+1 queries
    - Company names automatically included in `/data/positions/details` response

#### Investment Classification:
- **Position.investment_class**: Database field (PUBLIC/OPTIONS/PRIVATE)
  - PUBLIC: Regular equities, ETFs
  - OPTIONS: Options contracts (LC, LP, SC, SP position types)
  - PRIVATE: Private/alternative investments
- **Position.investment_subtype**: Optional categorization within investment class
- **API Response**: `/data/positions/details` now includes:
  - **company_name**: Company name from company_profiles table (batch fetched for performance)
  - investment_class: String field for position categorization
  - investment_subtype: Optional subtype classification
  - strike_price: For options contracts
  - expiration_date: For options contracts
  - underlying_symbol: For options contracts

#### Position Types:
- LONG: Long equity position
- SHORT: Short equity position
- LC: Long Call option
- LP: Long Put option
- SC: Short Call option (covered/naked)
- SP: Short Put option

#### Portfolio Snapshots & Equity Balance:
- **PortfolioSnapshot Table**: Daily historical snapshots of portfolio state
  - Captures complete portfolio metrics on each trading day
  - Includes valuations, exposures, P&L, Greeks, and position counts
- **equity_balance Field**: Tracks the capital account over time
  - Formula: `starting_equity_balance + realized_pnl`
  - Represents actual capital (starting balance + realized gains/losses)
  - Updated daily during batch processing BEFORE snapshot creation
  - Stored in both `portfolios.equity_balance` (current) and `portfolio_snapshots.equity_balance` (historical)
  - NOT the same as market value or unrealized P&L
  - Used for historical tracking of capital account changes

### ğŸ“ˆ Batch Processing Tables

#### Calculation Engines (8 total, 7 functional):
1. **Market Data Update**: Populates market_data_cache
2. **Position Greeks**: Calculates options Greeks
3. **Factor Exposures**: Portfolio & position-level factor betas
4. **Correlation Matrix**: Pairwise position correlations
5. **Stress Testing**: Scenario-based portfolio impacts
6. **Portfolio Aggregation**: Daily snapshots and returns
7. **Data Quality**: Validation and completeness checks
8. **Risk Metrics**: (Partially implemented)

### ğŸ” Security Features

1. **Authentication**:
   - JWT tokens with 30-day expiration
   - HTTP-only cookies for web clients
   - Password hashing with bcrypt

2. **Data Access**:
   - Row-level security via user_id/portfolio_id
   - Portfolio ownership validation
   - Audit trails with created_at/updated_at

3. **API Security**:
   - CORS configuration
   - Rate limiting on external API calls
   - Bearer token validation

### ğŸ’¾ Data Volume (Demo Environment)

- **Users**: 3 demo users
- **Portfolios**: 3 (HNW, Retail, Institutional)
- **Positions**: 63 total across portfolios
- **Market Data**: ~90 days historical for each symbol
- **Calculations**: Daily batch processing results

### ğŸš€ Performance Optimizations

1. **Database**:
   - UUID primary keys with indexes
   - Async SQLAlchemy 2.0 operations
   - Connection pooling
   - Optimized joins for complex queries

2. **Caching**:
   - Market data caching to reduce API calls
   - Factor ETF price caching
   - Calculation result persistence

3. **Batch Processing**:
   - Sequential engine execution
   - Graceful degradation on failures
   - Parallel position processing where possible

---

## Part III: Frontend Services Architecture

### Service Layer Overview
The frontend uses a layered service architecture to interact with the backend API. All API calls should go through the service layer rather than being made directly from components. Services are located in `/src/services/` and provide:
- Centralized API endpoint management
- Consistent error handling
- Request retry and deduplication
- Authentication token management
- Type-safe responses

### Frontend Services and API Endpoints

| Service | Purpose | API Endpoints Used | Used By |
|---------|---------|-------------------|----------|
| **apiClient.ts** | Base HTTP client with proxy support | All endpoints (infrastructure) | All services |
| **authManager.ts** | JWT token management & authentication | `/auth/login`, `/auth/me` | portfolioService, components |
| **portfolioService.ts** | Main portfolio data fetching | `/analytics/portfolio/{id}/overview`<br>`/data/positions/details`<br>`/analytics/portfolio/{id}/factor-exposures` | usePortfolioData hook |
| **portfolioResolver.ts** | Dynamic portfolio ID resolution | `/data/portfolios`<br>`/data/portfolio/{id}/complete` | portfolioService |
| **analyticsApi.ts** | Analytics & calculations | `/analytics/portfolio/{id}/overview`<br>`/analytics/portfolio/{id}/correlation-matrix`<br>`/analytics/portfolio/{id}/factor-exposures`<br>`/analytics/portfolio/{id}/stress-test` | Dashboard, Analytics pages |
| **portfolioApi.ts** | Portfolio CRUD operations | `/data/portfolios`<br>`/data/portfolio/{id}/complete`<br>`/data/portfolio/{id}/data-quality` | Portfolio management |
| **positionApiService.ts** | Position details & operations | `/data/positions/details` | Position components |
| **companyProfilesApi.ts** | Company profile data | `/data/company-profiles` | âœ¨ **NEW** - Position cards, research views |
| **strategiesApi.ts** | Strategy management | âŒ Removed | Delete service; migrate UI to tagsApi + position tags |
| **tagsApi.ts** | Tag + position tagging | `/tags/`<br>`/tags/defaults`<br>`/positions/{id}/tags`<br>`/tags/{id}/positions` | TagEditor, Organize page |
| **chatService.ts** | Chat conversation management | `/chat/conversations`<br>`/chat/send`<br>`/chat/conversations/{id}/mode` | ChatInterface component |
| **chatAuthService.ts** | Chat auth & streaming | `/auth/login`<br>`/auth/logout`<br>`/auth/me`<br>`/chat/send` | Chat components |
| **requestManager.ts** | Request retry & deduplication | N/A (infrastructure) | All services |

### Service Architecture Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Components/Pages                         â”‚
â”‚  (PortfolioPage, ChatInterface, StrategyList, TagEditor, etc.)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Custom Hooks                           â”‚
â”‚           (usePortfolioData, useFetchStreaming, etc.)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Service Layer                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Feature APIs â”‚ â”‚   Auth       â”‚ â”‚    Infrastructure        â”‚ â”‚
â”‚ â”‚analyticsApi â”‚ â”‚authManager   â”‚ â”‚    apiClient             â”‚ â”‚
â”‚ â”‚portfolioApi â”‚ â”‚chatAuthServiceâ”‚ â”‚    requestManager        â”‚ â”‚
â”‚ â”‚tagsApi      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js API Proxy                           â”‚
â”‚                    (/api/proxy/[...path])                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend API (FastAPI)                        â”‚
â”‚                    http://localhost:8000                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Centralized Configuration

The frontend uses centralized API configuration in `/src/config/api.ts`:

- **API_ENDPOINTS**: Organized mapping of all backend endpoints
- **REQUEST_CONFIGS**: Preset configurations for different operation types
  - STANDARD: Normal requests with caching
  - REALTIME: Short timeout, no caching
  - CALCULATION: Long timeout for complex operations
  - AUTH: Authentication-specific settings
- **API_CONFIG**: Environment-based settings (timeouts, retries, cache TTL)

### Service Usage Patterns

#### 1. Through Custom Hooks (Recommended)
```typescript
// usePortfolioData hook uses portfolioService internally
const { positions, publicPositions, optionsPositions } = usePortfolioData()
```

#### 2. Direct Service Usage in Components
```typescript
// Components import and use services directly
import tagsApi from '@/services/tagsApi'
const positionTags = await tagsApi.getPositionTags({ positionId })
```

#### 3. Proxy Routing
All API calls route through Next.js proxy at `/api/proxy/` to handle CORS during development.

### Best Practices

1. **Always use services** - Don't make direct fetch() calls to backend
2. **Use appropriate service** - Each service has a specific domain responsibility
3. **Handle errors gracefully** - Services provide consistent error handling
4. **Leverage request manager** - Automatic retry and deduplication
5. **Type safety** - Services provide TypeScript interfaces for responses

---

## Recent Updates & Fixes

### Phase 10.1-10.2: Railway Cron Hardening (October 7, 2025)
- **Removed 4x market data duplication**: Eliminated upfront market data sync step in Railway cron workflow
- **Market data now synced once per portfolio**: Batch orchestrator handles per-portfolio market data updates
- **Critical vs non-critical job distinction**: Portfolio failures only on critical job failures (market_data_update, portfolio_aggregation)
- **Enhanced failure detection**: Job-level failure details in completion summary with specific failed job names
- **Improved logging**: Detailed failure tracking per portfolio with critical/non-critical counts

### Phase 9.1-9.2: Company Profile Integration (October 7, 2025)
- **Automated company profile sync**: Added Step 1 to Railway cron workflow (runs daily at 11:30 PM UTC)
- **Non-blocking failures**: Profile sync failures don't stop batch calculations (graceful degradation)
- **Deprecated manual endpoint**: `POST /admin/batch/trigger/company-profiles` no longer needed for normal operations
- **Updated workflow**: 5-step process (trading day check â†’ profile sync â†’ batch calculations â†’ summary)
- **Documentation updated**: Railway README includes comprehensive troubleshooting for company profile sync failures

### Phase 9.0: Company Profile Fetcher Rewrite (October 7, 2025)
- **Complete async rewrite**: Migrated from blocking synchronous code to truly async via `run_in_executor()`
- **Batching + parallelism**: Process symbols in batches of 10 with ThreadPoolExecutor (max_workers=3)
- **Exponential backoff retry**: Retry failed fetches with 2^attempt second delays
- **Timezone-aware timestamps**: All datetimes use `datetime.now(timezone.utc)` for consistency
- **Database schema widened**: country/exchange columns expanded from 10/20 to 50 chars (Alembic migration 19c513d3bf90)
- **Graceful degradation**: Per-batch error handling preserves partial successes
- **Hybrid data source**: yfinance (basic info, reliable) + yahooquery (revenue/earnings estimates, unique data)
- **53 comprehensive fields**: Basic info, valuation metrics, analyst targets, profitability, forward estimates (current year + next year)


## Backend Services Architecture

### Company Profile Fetcher Service
**File**: `app/services/yahooquery_profile_fetcher.py`

**Purpose**: Fetch comprehensive company profile data from external APIs

**Data Sources**:
- **yfinance**: Basic company info (reliable, no rate limits)
  - Company name, sector, industry, description
  - Valuation metrics (P/E, beta, 52-week ranges)
  - Profitability metrics (margins, ROA, ROE)
  - Analyst targets and recommendations
- **yahooquery**: Revenue/earnings estimates (unique data)
  - Current year (0y) revenue/earnings estimates
  - Next year (+1y) revenue/earnings estimates
  - Growth rates and end dates

**Key Features**:
- **Async-safe execution**: Uses `run_in_executor()` to prevent blocking FastAPI event loop
- **Batching**: Processes symbols in batches of 10 to avoid rate limits
- **Parallelism**: ThreadPoolExecutor with max_workers=3 for concurrent fetching
- **Retry logic**: Exponential backoff (2^attempt seconds) for failed fetches
- **Graceful degradation**: Per-batch error handling preserves partial successes
- **Timezone-aware**: All timestamps use `datetime.now(timezone.utc)`

**Usage Pattern**:
```python
from app.services.yahooquery_profile_fetcher import fetch_company_profiles

# Fetch profiles for multiple symbols
profiles = await fetch_company_profiles(['AAPL', 'MSFT', 'GOOGL'])

# Returns: Dict[str, Dict[str, Any]]
# {
#   'AAPL': {
#     'company_name': 'Apple Inc.',
#     'sector': 'Technology',
#     'industry': 'Consumer Electronics',
#     'market_cap': Decimal('2800000000000'),
#     'pe_ratio': Decimal('28.5'),
#     ...  # 53 total fields
#   },
#   ...
# }
```

**Performance**:
- Batch of 10 symbols: ~3-5 seconds
- Portfolio of 50 symbols: ~15-20 seconds (5 batches)
- Rate limit backoff: 1 second between batches

**Integration**:
- **Automatic sync**: Railway cron runs daily at 11:30 PM UTC
- **Position details**: Company names batch-fetched and included in `/data/positions/details`
- **Manual sync**: Available via `/admin/batch/trigger/company-profiles` (deprecated in Phase 9.1)

---

## Notes

- **Database Location**: PostgreSQL via Docker (`docker-compose up -d`)
- **Migrations**: Managed via Alembic (`uv run alembic upgrade head`)
- **Demo Data**: Pre-seeded with `scripts/seed_database.py`
- **Admin Endpoints**: âœ… Fully implemented and registered (6 batch processing endpoints)
- **Company Profiles**: âœ… 53 comprehensive fields, automatic daily sync via Railway cron
- **Testing**: Frontend API test page at `/dev/api-test` validates all endpoints
