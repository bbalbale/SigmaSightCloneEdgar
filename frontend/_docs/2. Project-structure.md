# Project Structure

**Last Updated**: December 11, 2025

## Overview

The SigmaSight frontend follows Next.js 14 best practices with a clean separation between routing (in `/app`) and shared application code (in `/src`). This structure aligns with Next.js's "Option 1" pattern where the `app` directory remains at the project root while other code is organized in shared folders.

**Implementation Status**: Multi-page architecture is COMPLETE with 9 application pages operational. The container pattern is the standard across all authenticated pages.

## Current Directory Structure

```
frontend/
├── app/                              # Next.js App Router
│   ├── api/                          # API routes
│   │   ├── health/                   # Health check endpoint
│   │   │   └── route.ts
│   │   ├── openai-proxy/             # OpenAI API proxy
│   │   │   ├── route.ts
│   │   │   └── chat/completions/
│   │   │       └── route.ts
│   │   └── proxy/[...path]/          # Backend proxy (CORS handling)
│   │       └── route.ts
│   ├── dev/                          # Development tools
│   │   └── api-test/
│   │       └── page.tsx              # API testing page
│   ├── landing/                      # Marketing landing page
│   │   ├── components/
│   │   │   └── Header.tsx
│   │   ├── layout.tsx
│   │   └── page.tsx
│   ├── login/                        # Authentication
│   │   └── page.tsx
│   ├── command-center/               # Main dashboard (Command Center)
│   │   └── page.tsx
│   ├── research-and-analyze/         # Position research & analysis
│   │   └── page.tsx
│   ├── risk-metrics/                 # Risk analytics dashboard
│   │   └── page.tsx
│   ├── sigmasight-ai/                # AI chat interface
│   │   └── page.tsx
│   ├── settings/                     # User settings
│   │   └── page.tsx
│   ├── onboarding/                   # User onboarding flow
│   │   └── upload/
│   │       └── page.tsx
│   ├── test-user-creation/           # Test user creation (dev)
│   │   └── page.tsx
│   ├── providers.tsx                 # Auth context & global providers
│   ├── error.tsx                     # Global error handling
│   ├── layout.tsx                    # Root layout with navigation
│   ├── loading.tsx                   # Global loading state
│   └── page.tsx                      # Root page (redirects to /landing)
│
├── src/                              # Application Source Code
│   ├── containers/                   # Page container components (10 total)
│   │   ├── AIChatContainer.tsx
│   │   ├── CommandCenterContainer.tsx
│   │   ├── DashboardContainer.tsx
│   │   ├── OrganizeContainer.tsx
│   │   ├── PositionManagementContainer.tsx
│   │   ├── ResearchAndAnalyzeContainer.tsx
│   │   ├── RiskMetricsContainer.tsx
│   │   ├── SettingsContainer.tsx
│   │   ├── SigmaSightAIContainer.tsx
│   │   └── TestUserCreationContainer.tsx
│   │
│   ├── components/                   # React components
│   │   ├── app/                      # App-specific components
│   │   │   ├── ChatInput.tsx
│   │   │   ├── Header.tsx
│   │   │   └── ThemeToggle.tsx
│   │   ├── auth/                     # Authentication components
│   │   │   └── LoginForm.tsx
│   │   ├── chat/                     # Chat system components
│   │   │   ├── ChatConversationPane.tsx
│   │   │   ├── ChatInterface.tsx
│   │   │   └── ChatProvider.tsx
│   │   ├── claude-insights/          # Claude AI insights
│   │   │   └── ClaudeChatInterface.tsx
│   │   ├── command-center/           # Command Center components (8 total)
│   │   │   ├── AIInsightsButton.tsx
│   │   │   ├── AIInsightsRow.tsx
│   │   │   ├── HeroMetricsRow.tsx
│   │   │   ├── HoldingsTable.tsx
│   │   │   ├── HoldingsTableDesktop.tsx
│   │   │   ├── HoldingsTableMobile.tsx
│   │   │   ├── PerformanceMetricsRow.tsx
│   │   │   └── RiskMetricsRow.tsx
│   │   ├── common/                   # Shared reusable components
│   │   │   ├── BasePositionCard.tsx
│   │   │   ├── PositionList.tsx
│   │   │   └── PositionSectionHeader.tsx
│   │   ├── insights/                 # AI Insights components (5 total)
│   │   │   ├── GenerateInsightModal.tsx
│   │   │   ├── InsightCard.tsx
│   │   │   ├── InsightDetailModal.tsx
│   │   │   ├── InsightsList.tsx
│   │   │   └── index.ts
│   │   ├── navigation/               # Navigation components
│   │   │   ├── BottomNavigation.tsx
│   │   │   ├── ConditionalNavigationHeader.tsx
│   │   │   ├── NavigationHeader.tsx
│   │   │   ├── TopNavigationBar.tsx
│   │   │   └── UserDropdown.tsx
│   │   ├── onboarding/               # Onboarding components
│   │   │   ├── UploadSuccess.tsx
│   │   │   └── ValidationErrors.tsx
│   │   ├── organize/                 # Organize page components (11 total)
│   │   │   ├── CombineModal.tsx
│   │   │   ├── CombinePositionsButton.tsx
│   │   │   ├── LongPositionsList.tsx
│   │   │   ├── OptionsPositionsList.tsx
│   │   │   ├── PositionSelectionGrid.tsx
│   │   │   ├── PrivatePositionsList.tsx
│   │   │   ├── SelectablePositionCard.tsx
│   │   │   ├── ShortOptionsPositionsList.tsx
│   │   │   ├── ShortPositionsList.tsx
│   │   │   ├── TagBadge.tsx
│   │   │   ├── TagCreator.tsx
│   │   │   └── TagList.tsx
│   │   ├── portfolio/                # Portfolio components (14 total)
│   │   │   ├── AccountFilter.tsx
│   │   │   ├── AccountSummaryCard.tsx
│   │   │   ├── FilterBar.tsx
│   │   │   ├── ManageEquitySidePanel.tsx
│   │   │   ├── ManagePositionsSidePanel.tsx
│   │   │   ├── OptionsPositions.tsx
│   │   │   ├── PortfolioError.tsx
│   │   │   ├── PortfolioHeader.tsx
│   │   │   ├── PortfolioMetrics.tsx
│   │   │   ├── PortfolioPositions.tsx
│   │   │   ├── PositionCategoryExposureCards.tsx
│   │   │   ├── PrivatePositions.tsx
│   │   │   ├── PublicPositions.tsx
│   │   │   ├── SpreadFactorCards.tsx
│   │   │   ├── TagEditor.tsx
│   │   │   └── VolatilityMetrics.tsx
│   │   ├── positions/                # Position card components (9 total)
│   │   │   ├── CreatePositionDialog.tsx
│   │   │   ├── EnhancedPositionsSection.tsx
│   │   │   ├── OptionPositionCard.tsx
│   │   │   ├── OrganizePositionCard.tsx
│   │   │   ├── PositionDetailSheet.tsx
│   │   │   ├── PositionManagementTable.tsx
│   │   │   ├── PrivatePositionCard.tsx
│   │   │   ├── ResearchPositionCard.tsx
│   │   │   └── StockPositionCard.tsx
│   │   ├── research-and-analyze/     # Research page components (15 total)
│   │   │   ├── CompactReturnsCards.tsx
│   │   │   ├── CompactTagBar.tsx
│   │   │   ├── CorrelationDebugger.tsx
│   │   │   ├── CorrelationsSection.tsx
│   │   │   ├── FinancialSummaryTable.tsx
│   │   │   ├── FinancialsTab.tsx
│   │   │   ├── MetricSection.tsx
│   │   │   ├── PositionSidePanel.tsx
│   │   │   ├── ResearchTableMobile.tsx
│   │   │   ├── ResearchTableView.tsx
│   │   │   ├── StickyTagBar.tsx
│   │   │   ├── StickyTagBarDesktop.tsx
│   │   │   ├── StickyTagBarMobile.tsx
│   │   │   ├── TableFooter.tsx
│   │   │   └── ViewAllTagsModal.tsx
│   │   ├── risk/                     # Risk analysis components
│   │   │   ├── CorrelationMatrix.tsx
│   │   │   └── DiversificationScore.tsx
│   │   ├── risk-metrics/             # Risk metrics components
│   │   │   ├── ConcentrationMetrics.tsx
│   │   │   ├── FactorExposureHeroRow.tsx
│   │   │   └── SectorExposure.tsx
│   │   ├── ui/                       # ShadCN UI components
│   │   │   ├── alert-dialog.tsx
│   │   │   ├── badge.tsx
│   │   │   ├── button.tsx
│   │   │   ├── card.tsx
│   │   │   ├── dialog.tsx
│   │   │   ├── input.tsx
│   │   │   ├── select.tsx
│   │   │   └── sheet.tsx
│   │   ├── DataQualityIndicator.tsx
│   │   ├── DataSourceIndicator.tsx
│   │   ├── PortfolioSelectionDialog.tsx
│   │   └── ThemeSelector.tsx
│   │
│   ├── contexts/                     # React contexts
│   │   └── ThemeContext.tsx
│   │
│   ├── hooks/                        # Custom React hooks (30 total)
│   │   ├── useAIInsights.ts          # AI insights data
│   │   ├── useCommandCenterData.ts   # Command center data aggregation
│   │   ├── useConcentration.ts       # Concentration metrics
│   │   ├── useCorrelationMatrix.ts   # Correlation matrix data
│   │   ├── useDiversificationScore.ts # Diversification scoring
│   │   ├── useFactorExposures.ts     # Factor exposure data
│   │   ├── useFetchStreaming.ts      # Streaming chat responses
│   │   ├── useFundamentals.ts        # Fundamental financial data
│   │   ├── useInsights.ts            # Insights management
│   │   ├── useMarketBetas.ts         # Market beta calculations
│   │   ├── useMediaQuery.ts          # Responsive design helper
│   │   ├── useMultiPortfolio.ts      # Multi-portfolio aggregation
│   │   ├── usePortfolioData.ts       # Portfolio data fetching
│   │   ├── usePortfolioUpload.ts     # Portfolio upload functionality
│   │   ├── usePositionCorrelations.ts # Position-level correlations
│   │   ├── usePositionFactorData.ts  # Position factor exposures
│   │   ├── usePositionRiskMetrics.ts # Position risk metrics
│   │   ├── usePositions.ts           # Position data fetching
│   │   ├── usePositionSelection.ts   # Multi-select for positions
│   │   ├── usePositionTags.ts        # Position tagging
│   │   ├── usePrivatePositions.ts    # Private positions
│   │   ├── usePublicPositions.ts     # Public positions
│   │   ├── useRecalculateAnalytics.ts # Analytics recalculation
│   │   ├── useRegistration.ts        # User registration
│   │   ├── useRestoreSectorTags.ts   # Sector tag restoration
│   │   ├── useSectorExposure.ts      # Sector exposure data
│   │   ├── useSpreadFactors.ts       # Spread factor calculations
│   │   ├── useStressTest.ts          # Stress test scenarios
│   │   ├── useTags.ts                # Tag management
│   │   └── useVolatility.ts          # Volatility analytics
│   │
│   ├── lib/                          # Utility libraries (9 total)
│   │   ├── auth.ts                   # Authentication utilities
│   │   ├── chatManager.ts            # Chat state management
│   │   ├── dal.ts                    # Data access layer
│   │   ├── financialFormatters.ts    # Financial number formatting
│   │   ├── formatters.ts             # General formatting utilities
│   │   ├── portfolioType.ts          # Portfolio type definitions
│   │   ├── themes.ts                 # Theme configuration
│   │   ├── types.ts                  # Shared type definitions
│   │   └── utils.ts                  # General utilities
│   │
│   ├── services/                     # API services (22 total)
│   │   ├── analyticsApi.ts           # Analytics endpoints
│   │   ├── apiClient.ts              # Base HTTP client
│   │   ├── authManager.ts            # Authentication management
│   │   ├── chatAuthService.ts        # Chat authentication
│   │   ├── chatService.ts            # Chat messaging
│   │   ├── claudeInsightsService.ts  # Claude AI insights (SSE)
│   │   ├── equityChangeService.ts    # Equity change tracking
│   │   ├── fundamentalsApi.ts        # Fundamental data API
│   │   ├── insightsApi.ts            # Insights API
│   │   ├── onboardingService.ts      # Onboarding API
│   │   ├── portfolioApi.ts           # Portfolio API operations
│   │   ├── portfolioResolver.ts      # Portfolio ID resolution
│   │   ├── portfolioService.ts       # Portfolio data fetching
│   │   ├── positionApiService.ts     # Position CRUD operations
│   │   ├── positionManagementService.ts # Position management
│   │   ├── positionResearchService.ts # Research data integration
│   │   ├── positionRiskService.ts    # Position risk data
│   │   ├── requestManager.ts         # Request retry/deduplication
│   │   ├── spreadFactorsApi.ts       # Spread factors API
│   │   ├── tagsApi.ts                # Tag & position tagging API
│   │   ├── targetPriceService.ts     # Target price management
│   │   └── targetPriceUpdateService.ts # Target price updates
│   │
│   ├── stores/                       # Zustand state management (5 total)
│   │   ├── chatStore.ts              # Chat persistent data
│   │   ├── claudeInsightsStore.ts    # Claude insights state
│   │   ├── portfolioStore.ts         # Global portfolio ID
│   │   ├── researchStore.ts          # Research page state
│   │   └── streamStore.ts            # Streaming state
│   │
│   └── types/                        # TypeScript type definitions (5 total)
│       ├── analytics.ts              # Analytics types
│       ├── portfolio.ts              # Portfolio types
│       ├── positions.ts              # Position types
│       ├── strategies.ts             # Strategy types (legacy)
│       └── tags.ts                   # Tag types
│
├── public/                           # Static assets
├── tests/                            # Test files
├── _docs/                            # Documentation
├── .env.local                        # Local environment overrides
├── Dockerfile                        # Docker configuration
├── docker-compose.yml                # Docker Compose config
├── next.config.js                    # Next.js configuration
├── package.json                      # Dependencies
├── tailwind.config.js                # Tailwind CSS config
└── tsconfig.json                     # TypeScript config
```

---

## Architecture Principles

### 1. Container Pattern (Standard)

All authenticated pages follow the container pattern:
- **Thin route files** (5-15 lines): Just import and render container
- **Container components** (150-500+ lines): Business logic and composition
- Better for code splitting and Docker optimization

### 2. Separation of Concerns

- **`/app`**: Next.js routing files only (thin wrappers)
- **`/src/containers`**: Business logic for pages
- **`/src/components`**: Reusable UI components
- **`/src/hooks`**: Data fetching and state logic
- **`/src/services`**: API communication layer

### 3. Import Path Strategy

- All imports use absolute paths via the `@/` alias
- `@/` maps to `./src/` in tsconfig.json
- Example: `import { Button } from '@/components/ui/button'`

### 4. State Management

- **Portfolio ID**: Stored in Zustand portfolioStore (global, no URL params)
- **User Auth**: React Context in providers.tsx
- **Chat State**: Split between chatStore and streamStore
- **Research State**: researchStore for Research & Analyze page
- **Claude Insights**: claudeInsightsStore for AI chat

### 5. Service Layer Architecture

ALL API calls must go through the service layer. Never make direct `fetch()` calls.

---

## Key Routes

### Public Routes
- `/` - Redirects to `/landing`
- `/landing` - Marketing landing page
- `/login` - Authentication page

### Protected Routes (Authenticated)
- `/command-center` - Main dashboard with hero metrics
- `/research-and-analyze` - Position research and analysis
- `/risk-metrics` - Risk analytics dashboard
- `/sigmasight-ai` - AI chat interface (Claude)
- `/settings` - User preferences

### Utility Routes
- `/onboarding/upload` - Portfolio upload flow
- `/test-user-creation` - Test user creation (dev)
- `/dev/api-test` - API testing interface

---

## Component Organization

### Component Categories

| Category | Purpose | Count |
|----------|---------|-------|
| `command-center/` | Dashboard components | 8 |
| `research-and-analyze/` | Research page components | 15 |
| `portfolio/` | Portfolio display components | 14 |
| `organize/` | Position organization | 11 |
| `positions/` | Position cards/tables | 9 |
| `navigation/` | Navigation UI | 5 |
| `insights/` | AI insights display | 5 |
| `risk-metrics/` | Risk metric displays | 3 |
| `ui/` | ShadCN base components | 8 |

### Component Layers

**1. Foundation Layer** (`/src/components/common/`)
- `BasePositionCard.tsx` - Pure presentation component
- `PositionSectionHeader.tsx` - Section headers with badges
- `PositionList.tsx` - Generic list container

**2. Adapter Layer** (`/src/components/positions/`)
- `StockPositionCard.tsx` - For stocks/ETFs
- `OptionPositionCard.tsx` - For options contracts
- `PrivatePositionCard.tsx` - For private investments
- `OrganizePositionCard.tsx` - For organize page (no P&L)
- `ResearchPositionCard.tsx` - For research view

**3. Page-Specific Layer**
- `command-center/` - Command Center specific
- `research-and-analyze/` - Research page specific
- `risk-metrics/` - Risk metrics specific

---

## Data Flow Architecture

```
User Action
    ↓
Component/Page
    ↓
Custom Hook (data fetching/state)
    ↓
Service Layer (API calls)
    ↓
Next.js Proxy (/api/proxy/*)
    ↓
FastAPI Backend (localhost:8000 or Railway)
```

### Authentication Flow

1. User logs in at `/login`
2. JWT token stored in localStorage as `access_token`
3. Portfolio ID resolved via `portfolioResolver` and stored in Zustand
4. Token used for all API calls via service layer
5. Portfolio ID persists across all page navigations
6. Logout clears both token and portfolio ID

---

## Development Workflow

### File Placement Guidelines

1. **New page?** → Add thin wrapper to `/app/[route]/page.tsx`
2. **Page logic?** → Add container to `/src/containers/[Page]Container.tsx`
3. **New component?** → Add to `/src/components/[category]/`
4. **New hook?** → Add to `/src/hooks/`
5. **New service?** → Add to `/src/services/`
6. **New utility?** → Add to `/src/lib/`
7. **New type?** → Add to `/src/types/`
8. **Global state?** → Add to `/src/stores/`

### Import Examples

```typescript
// Containers
import { CommandCenterContainer } from '@/containers/CommandCenterContainer'
import { ResearchAndAnalyzeContainer } from '@/containers/ResearchAndAnalyzeContainer'

// Components
import { NavigationHeader } from '@/components/navigation/NavigationHeader'
import { HeroMetricsRow } from '@/components/command-center/HeroMetricsRow'
import { Button } from '@/components/ui/button'

// Hooks
import { usePortfolioData } from '@/hooks/usePortfolioData'
import { useCommandCenterData } from '@/hooks/useCommandCenterData'
import { useFundamentals } from '@/hooks/useFundamentals'

// Stores
import { usePortfolioStore } from '@/stores/portfolioStore'
import { useResearchStore } from '@/stores/researchStore'

// Services
import { apiClient } from '@/services/apiClient'
import { analyticsApi } from '@/services/analyticsApi'
import tagsApi from '@/services/tagsApi'

// Utilities
import { cn } from '@/lib/utils'
import { formatCurrency, formatPercent } from '@/lib/formatters'

// Types
import type { FactorExposure } from '@/types/analytics'
import type { Position } from '@/types/positions'
```

---

## Hooks Reference

### Data Fetching Hooks (Analytics)
| Hook | Purpose |
|------|---------|
| `usePortfolioData` | Core portfolio data |
| `useCommandCenterData` | Aggregated dashboard data |
| `usePositions` | Position data fetching |
| `useFundamentals` | Financial statements & estimates |
| `useFactorExposures` | Factor exposure data |
| `useSectorExposure` | Sector exposure vs S&P 500 |
| `useConcentration` | Concentration metrics (HHI) |
| `useVolatility` | Volatility analytics |
| `useCorrelationMatrix` | Correlation matrix |
| `useStressTest` | Stress test scenarios |
| `useDiversificationScore` | Diversification scoring |
| `useMarketBetas` | Market beta calculations |
| `useSpreadFactors` | Spread factor data |

### Feature Hooks
| Hook | Purpose |
|------|---------|
| `useAIInsights` | AI-generated insights |
| `useTags` | Tag management |
| `usePositionTags` | Position tagging |
| `usePositionSelection` | Multi-select functionality |
| `useFetchStreaming` | SSE streaming responses |
| `useMultiPortfolio` | Multi-portfolio aggregation |

### Utility Hooks
| Hook | Purpose |
|------|---------|
| `useMediaQuery` | Responsive design helper |
| `useRegistration` | User registration |
| `usePortfolioUpload` | Portfolio upload |
| `useRecalculateAnalytics` | Trigger recalculation |

---

## Services Reference

### Core Services
| Service | Purpose |
|---------|---------|
| `apiClient` | Base HTTP client with retry |
| `authManager` | JWT token management |
| `portfolioResolver` | Portfolio ID resolution |
| `requestManager` | Request deduplication |

### Data Services
| Service | Purpose |
|---------|---------|
| `portfolioService` | Portfolio data fetching |
| `portfolioApi` | Portfolio CRUD operations |
| `positionApiService` | Position CRUD operations |
| `positionManagementService` | Position management |
| `positionResearchService` | Research data |
| `positionRiskService` | Position risk data |
| `analyticsApi` | Analytics endpoints |
| `fundamentalsApi` | Financial fundamentals |
| `spreadFactorsApi` | Spread factors |

### Feature Services
| Service | Purpose |
|---------|---------|
| `tagsApi` | Tag & position tagging |
| `targetPriceService` | Target price management |
| `chatService` | Chat messaging |
| `claudeInsightsService` | Claude AI (SSE) |
| `insightsApi` | Insights management |
| `onboardingService` | User onboarding |

---

## Key Architectural Decisions

### Why Container Pattern?
- Better Docker optimization (code splitting)
- Clear separation of concerns
- Easier testing and maintenance
- Follows Next.js best practices

### Why Zustand for Portfolio ID?
- Persists across page navigations
- No URL parameter pollution
- Cleaner URLs and better security
- Single source of truth

### Why Client-Side Only?
- Backend is FastAPI (not Next.js backend)
- Simplifies architecture
- Avoids SSR complexity
- Better for SPA-like experience

### Why Remove Strategy Endpoints?
- Simplified to position-level tagging only (October 2025)
- Better performance and maintainability
- Use `tagsApi` for all tag operations

---

## Summary Statistics

| Category | Count |
|----------|-------|
| Application Pages | 9 |
| Containers | 10 |
| Components | 80+ |
| Hooks | 30 |
| Services | 22 |
| Stores | 5 |
| Type Definitions | 5 |
| Utility Libraries | 9 |

**Status**: Production-ready multi-page application with comprehensive analytics, AI chat, and portfolio management features.
